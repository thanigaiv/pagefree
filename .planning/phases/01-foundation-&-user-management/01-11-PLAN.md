---
phase: 01-foundation-&-user-management
plan: 11
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/notification.service.ts
  - src/tests/scim.test.ts
  - src/tests/team.test.ts
  - src/tests/setup.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "TypeScript compilation succeeds without errors"
    - "npm run build completes successfully"
  artifacts:
    - path: "src/services/notification.service.ts"
      provides: "AWS SES client with proper credential handling"
    - path: "src/tests/scim.test.ts"
      provides: "Clean test file with no TypeScript errors"
    - path: "src/tests/team.test.ts"
      provides: "Clean test file with no TypeScript errors"
    - path: "src/tests/setup.ts"
      provides: "Clean test setup with no unused imports"
  key_links:
    - from: "src/services/notification.service.ts"
      to: "AWS SDK SESClient"
      via: "conditional credential initialization"
      pattern: "credentials.*accessKeyId.*secretAccessKey"
---

<objective>
Fix TypeScript compilation errors identified during Phase 1 verification.

Purpose: Enable successful `npm run build` by resolving type errors in notification service and test files
Output: Clean TypeScript compilation with zero errors
</objective>

<context>
@.planning/phases/01-foundation-&-user-management/01-VERIFICATION.md
@src/services/notification.service.ts
@src/tests/scim.test.ts
@src/tests/team.test.ts
@src/tests/setup.ts
@src/config/env.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix AWS SES credentials type error in notification service</name>
  <files>src/services/notification.service.ts</files>
  <action>
Fix the TypeScript error where AWS SES credentials may be undefined.

The issue: `env.AWS_ACCESS_KEY_ID` and `env.AWS_SECRET_ACCESS_KEY` are optional in the env schema, but the SESClient credentials object requires defined strings.

Solution: Conditionally initialize SES client only when credentials are present. If credentials are missing, the service should gracefully handle this (e.g., log a warning, return false for email sends).

Implementation:
1. Check if AWS credentials are present before creating SESClient with explicit credentials
2. If credentials are missing, either:
   - Use AWS SDK's default credential chain (environment variables, IAM role, etc.) by omitting the credentials option entirely
   - Or set sesClient to null and handle gracefully in sendEmail
3. Recommended approach: Omit explicit credentials when env vars are undefined, allowing AWS SDK to use its default credential provider chain (which supports IAM roles, environment variables, etc.)

Update constructor:
```typescript
constructor() {
  // Initialize AWS SES - use default credential chain if explicit creds not provided
  const sesConfig: SESClientConfig = {
    region: env.AWS_REGION
  };

  // Only add explicit credentials if both are provided
  if (env.AWS_ACCESS_KEY_ID && env.AWS_SECRET_ACCESS_KEY) {
    sesConfig.credentials = {
      accessKeyId: env.AWS_ACCESS_KEY_ID,
      secretAccessKey: env.AWS_SECRET_ACCESS_KEY
    };
  }

  this.sesClient = new SESClient(sesConfig);
  // ... rest of constructor
}
```

Also add the import for SESClientConfig type from @aws-sdk/client-ses.
  </action>
  <verify>Run `npx tsc --noEmit` and verify no errors in notification.service.ts</verify>
  <done>SESClient initializes without type errors, supporting both explicit credentials and default credential chain</done>
</task>

<task type="auto">
  <name>Task 2: Fix TypeScript errors in test files</name>
  <files>src/tests/scim.test.ts, src/tests/team.test.ts, src/tests/setup.ts</files>
  <action>
Fix unused variable warnings and implicit any types in test files.

Issues to fix:

1. **src/tests/scim.test.ts**:
   - Line 5: Remove unused import `createTestTeam` from import statement
   - Line 58: Add explicit type to the `.every()` callback parameter:
     Change: `Resources.every(u => !u.externalId?.includes('breakglass'))`
     To: `Resources.every((u: { externalId?: string }) => !u.externalId?.includes('breakglass'))`
     Or use type assertion on Resources if there's a SCIM response type

2. **src/tests/team.test.ts**:
   - Line 8: Either remove the unused `authenticatedAgent` function OR prefix with underscore (`_authenticatedAgent`) to indicate intentionally unused (kept for future use)
   - Line 44: Either use the `admin` variable in the test OR remove/prefix with underscore. Since the test comment says "Would need authenticated request", remove the variable assignment since the test is incomplete anyway.

3. **src/tests/setup.ts**:
   - Line 2: Remove unused `beforeEach` from the import statement (keep only `beforeAll`, `afterAll`)

These are code quality fixes that don't change functionality.
  </action>
  <verify>Run `npx tsc --noEmit` and verify no errors in test files</verify>
  <done>All test files compile without TypeScript errors or unused variable warnings</done>
</task>

</tasks>

<verification>
After completing both tasks:

1. Run full TypeScript check:
   ```bash
   npx tsc --noEmit
   ```
   Expected: Exit code 0, no errors

2. Run build:
   ```bash
   npm run build
   ```
   Expected: Successful build with no errors

3. Run tests to ensure fixes didn't break anything:
   ```bash
   npm test
   ```
   Expected: All tests pass (or skip gracefully if test database not configured)
</verification>

<success_criteria>
- `npx tsc --noEmit` exits with code 0
- `npm run build` completes successfully
- No TypeScript errors in any source files
- Notification service properly handles optional AWS credentials
- Test files have no unused variables or implicit any types
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-&-user-management/01-11-SUMMARY.md`
</output>
