---
phase: 03-scheduling-system
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/types/schedule.ts
  - src/services/schedule.service.ts
  - src/routes/schedule.routes.ts
  - src/index.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "User can create schedule with daily rotation (SCHED-01)"
    - "User can create schedule with weekly rotation (SCHED-02)"
    - "User can create schedule with custom rotation interval (SCHED-03)"
    - "Schedule stores RRULE recurrence pattern computed from rotation settings"
    - "Timezone is validated as valid IANA timezone name"
  artifacts:
    - path: "src/types/schedule.ts"
      provides: "Schedule type definitions and Zod schemas"
      min_lines: 50
    - path: "src/services/schedule.service.ts"
      provides: "ScheduleService with CRUD operations"
      exports: ["ScheduleService"]
    - path: "src/routes/schedule.routes.ts"
      provides: "Schedule API routes"
      min_lines: 80
  key_links:
    - from: "src/routes/schedule.routes.ts"
      to: "src/services/schedule.service.ts"
      via: "import and method calls"
      pattern: "ScheduleService"
    - from: "src/services/schedule.service.ts"
      to: "prisma.schedule"
      via: "Prisma client queries"
      pattern: "prisma\\.schedule\\.(create|update|find)"
---

<objective>
Create the schedule CRUD service and API routes supporting daily, weekly, and custom rotation patterns with RRULE generation.

Purpose: Enable teams to create and manage on-call schedules with flexible rotation patterns (SCHED-01, SCHED-02, SCHED-03).

Output: Schedule types, service layer with CRUD operations, and REST API routes with Zod validation.
</objective>

<execution_context>
@/Users/tvellore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tvellore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-scheduling-system/03-RESEARCH.md
@.planning/phases/03-scheduling-system/03-01-SUMMARY.md
@prisma/schema.prisma
@src/services/team.service.ts
@src/routes/team.routes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create schedule types</name>
  <files>package.json, src/types/schedule.ts</files>
  <action>
Install required dependencies:
```bash
npm install luxon rrule
npm install --save-dev @types/luxon
```

Create src/types/schedule.ts with:

1. Import dependencies:
   - Zod for validation schemas
   - IANAZone from luxon for timezone validation

2. Create Zod validation schemas:
   - CreateScheduleInput schema with:
     - teamId: z.string().cuid()
     - name: z.string().min(1).max(100)
     - description: z.string().optional()
     - timezone: z.string() with custom validator using IANAZone.isValidZone()
     - startDate: z.string().datetime() (ISO format)
     - endDate: z.string().datetime().optional()
     - handoffTime: z.string().regex(/^([01]\d|2[0-3]):([0-5]\d)$/) (HH:MM)
     - rotationType: z.enum(['daily', 'weekly', 'custom'])
     - rotationIntervalDays: z.number().int().min(1).max(365).optional() (for custom)
     - rotationUserIds: z.array(z.string().cuid()).min(1)

   - UpdateScheduleInput schema (all fields optional except id)

   - ScheduleListQuery schema:
     - teamId: z.string().cuid().optional()
     - isActive: z.boolean().optional()

3. Export TypeScript types inferred from schemas:
   - export type CreateScheduleInput = z.infer<typeof CreateScheduleInputSchema>
   - export type UpdateScheduleInput = z.infer<typeof UpdateScheduleInputSchema>
   - export type ScheduleListQuery = z.infer<typeof ScheduleListQuerySchema>

4. Export interface ScheduleWithDetails extending Prisma Schedule with:
   - team: { id: string; name: string }
   - layers?: ScheduleLayer[]
   - _count?: { overrides: number }
  </action>
  <verify>Run `npm run build` - TypeScript should compile without errors</verify>
  <done>Luxon and rrule installed, schedule types created with Zod validation including IANA timezone validation</done>
</task>

<task type="auto">
  <name>Task 2: Create schedule service with RRULE generation</name>
  <files>src/services/schedule.service.ts</files>
  <action>
Create src/services/schedule.service.ts with ScheduleService class containing:

1. Import dependencies:
   - PrismaClient from database config
   - RRule from rrule library
   - DateTime, IANAZone from luxon
   - Types from schedule types file
   - AuditService for logging

2. Private helper: generateRRule(input) that creates RRULE string based on rotation type:
   ```typescript
   private generateRRule(input: {
     rotationType: 'daily' | 'weekly' | 'custom';
     rotationIntervalDays?: number;
     startDate: Date;
     timezone: string;
     handoffTime: string;
   }): string {
     const [hours, minutes] = input.handoffTime.split(':').map(Number);
     const start = DateTime.fromJSDate(input.startDate, { zone: input.timezone })
       .set({ hour: hours, minute: minutes, second: 0 });

     let rule: RRule;
     switch (input.rotationType) {
       case 'daily':
         rule = new RRule({
           freq: RRule.DAILY,
           interval: 1,
           dtstart: start.toJSDate(),
         });
         break;
       case 'weekly':
         rule = new RRule({
           freq: RRule.WEEKLY,
           interval: 1,
           dtstart: start.toJSDate(),
         });
         break;
       case 'custom':
         rule = new RRule({
           freq: RRule.DAILY,
           interval: input.rotationIntervalDays || 7,
           dtstart: start.toJSDate(),
         });
         break;
     }
     return rule.toString();
   }
   ```

3. create(input, userId) method:
   - Validate timezone using IANAZone.isValidZone()
   - Validate all rotationUserIds exist and are team members
   - Generate RRULE from rotation settings
   - Create schedule in database with:
     - All input fields
     - Generated recurrenceRule
     - startDate parsed to Date
   - Audit log: schedule.created with HIGH severity
   - Return schedule with team relation

4. findById(id) method:
   - Find schedule with team and layers included
   - Return null if not found

5. findAll(query) method:
   - Filter by teamId and isActive if provided
   - Include team relation
   - Order by createdAt desc

6. findByTeam(teamId) method:
   - Find all schedules for a team
   - Filter by isActive = true
   - Include layers count

7. update(id, input, userId) method:
   - If rotationType, startDate, handoffTime, or rotationIntervalDays changed, regenerate RRULE
   - If rotationUserIds changed, validate all exist and are team members
   - Update schedule in database
   - Audit log: schedule.updated with INFO severity
   - Return updated schedule

8. archive(id, userId) method:
   - Set isActive = false
   - Also set all layers isActive = false
   - Audit log: schedule.archived with HIGH severity
   - Return archived schedule

9. delete(id, userId) method:
   - Hard delete schedule (cascades to layers and overrides per schema)
   - Audit log: schedule.deleted with HIGH severity
  </action>
  <verify>Run `npm run build` - TypeScript should compile without errors</verify>
  <done>ScheduleService created with CRUD operations and RRULE generation for daily/weekly/custom rotations</done>
</task>

<task type="auto">
  <name>Task 3: Create schedule routes and mount to app</name>
  <files>src/routes/schedule.routes.ts, src/index.ts</files>
  <action>
Create src/routes/schedule.routes.ts with Express router:

1. Import dependencies:
   - express Router
   - ScheduleService
   - Zod schemas from types
   - RBAC middleware (requireAuth, requireTeamRole)
   - asyncHandler wrapper for error handling

2. Define routes:

POST /api/schedules
- Auth: requireAuth
- Body validation: CreateScheduleInputSchema
- Permission: Must be team admin of the target team
- Call ScheduleService.create(input, req.user.id)
- Return 201 with created schedule

GET /api/schedules
- Auth: requireAuth
- Query validation: ScheduleListQuerySchema
- Call ScheduleService.findAll(query)
- Return 200 with schedules array

GET /api/schedules/:id
- Auth: requireAuth
- Call ScheduleService.findById(id)
- Return 404 if not found
- Return 200 with schedule

GET /api/teams/:teamId/schedules
- Auth: requireAuth
- Call ScheduleService.findByTeam(teamId)
- Return 200 with schedules array

PATCH /api/schedules/:id
- Auth: requireAuth
- Body validation: UpdateScheduleInputSchema
- Permission: Must be team admin of the schedule's team
- Call ScheduleService.update(id, input, req.user.id)
- Return 200 with updated schedule

DELETE /api/schedules/:id
- Auth: requireAuth
- Permission: Must be team admin or platform admin
- Call ScheduleService.delete(id, req.user.id)
- Return 204 No Content

POST /api/schedules/:id/archive
- Auth: requireAuth
- Permission: Must be team admin of the schedule's team
- Call ScheduleService.archive(id, req.user.id)
- Return 200 with archived schedule

Update src/index.ts:
- Import schedule routes
- Mount at /api/schedules before error handler
  </action>
  <verify>Run `npm run build` and start server. Test with curl:
- POST /api/schedules with valid rotation data
- GET /api/schedules should return created schedule
- PATCH /api/schedules/:id should update
</verify>
  <done>Schedule API routes created and mounted with proper RBAC enforcement</done>
</task>

</tasks>

<verification>
1. Run `npm run build` - TypeScript compiles without errors
2. Run `npm run dev` and test endpoints:
   - POST /api/schedules with daily rotation returns 201
   - POST /api/schedules with weekly rotation returns 201
   - POST /api/schedules with custom (14-day) rotation returns 201
   - GET /api/schedules returns list
   - GET /api/schedules/:id returns schedule with team
   - PATCH /api/schedules/:id updates schedule
   - DELETE /api/schedules/:id removes schedule
3. Verify RRULE is generated:
   - daily: contains "FREQ=DAILY;INTERVAL=1"
   - weekly: contains "FREQ=WEEKLY;INTERVAL=1"
   - custom: contains "FREQ=DAILY;INTERVAL={N}"
4. Verify timezone validation rejects invalid timezones
5. Verify audit logs created for schedule operations
</verification>

<success_criteria>
- luxon and rrule dependencies installed
- Schedule types with Zod validation schemas exist
- ScheduleService handles CRUD with RRULE generation
- Schedule API routes enforce RBAC
- Daily, weekly, and custom rotations generate correct RRULEs
- Invalid timezones rejected with clear error message
</success_criteria>

<output>
After completion, create `.planning/phases/03-scheduling-system/03-02-SUMMARY.md`
</output>
