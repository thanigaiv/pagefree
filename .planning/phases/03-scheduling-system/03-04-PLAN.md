---
phase: 03-scheduling-system
plan: 04
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - src/types/schedule.ts
  - src/services/scheduleOverride.service.ts
  - src/routes/scheduleOverride.routes.ts
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "User can create override for temporary coverage changes (SCHED-04)"
    - "User can swap shifts with another team member (SCHED-05)"
    - "Overrides cannot overlap with existing overrides for same schedule"
    - "System validates override user is a team member"
  artifacts:
    - path: "src/services/scheduleOverride.service.ts"
      provides: "ScheduleOverrideService with override and swap management"
      exports: ["ScheduleOverrideService"]
    - path: "src/routes/scheduleOverride.routes.ts"
      provides: "Override API routes"
      min_lines: 60
  key_links:
    - from: "src/routes/scheduleOverride.routes.ts"
      to: "src/services/scheduleOverride.service.ts"
      via: "import and method calls"
      pattern: "ScheduleOverrideService"
    - from: "src/services/scheduleOverride.service.ts"
      to: "prisma.scheduleOverride"
      via: "Prisma client queries with transaction"
      pattern: "prisma\\.\\$transaction"
---

<objective>
Add schedule override management for temporary coverage changes and shift swaps with conflict detection.

Purpose: Enable schedule flexibility for vacations, emergencies, and shift swaps between team members (SCHED-04, SCHED-05).

Output: ScheduleOverrideService and API routes for creating overrides with overlap detection and swap workflow.
</objective>

<execution_context>
@/Users/tvellore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tvellore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-scheduling-system/03-RESEARCH.md
@.planning/phases/03-scheduling-system/03-01-SUMMARY.md
@.planning/phases/03-scheduling-system/03-02-SUMMARY.md
@prisma/schema.prisma
@src/types/schedule.ts
@src/services/schedule.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add override types and validation schemas</name>
  <files>src/types/schedule.ts</files>
  <action>
Extend src/types/schedule.ts with override-related types:

1. Add override input schemas:
   ```typescript
   export const CreateOverrideInputSchema = z.object({
     scheduleId: z.string().cuid(),
     userId: z.string().cuid(), // Who is covering
     startTime: z.string().datetime(), // ISO timestamp
     endTime: z.string().datetime(),
     reason: z.string().max(200).optional(),
   }).refine(
     (data) => new Date(data.endTime) > new Date(data.startTime),
     { message: 'End time must be after start time' }
   );

   export const CreateSwapInputSchema = z.object({
     scheduleId: z.string().cuid(),
     originalUserId: z.string().cuid(), // Who originally has the shift
     newUserId: z.string().cuid(), // Who is taking over
     startTime: z.string().datetime(),
     endTime: z.string().datetime(),
     reason: z.string().max(200).optional(),
   }).refine(
     (data) => new Date(data.endTime) > new Date(data.startTime),
     { message: 'End time must be after start time' }
   ).refine(
     (data) => data.originalUserId !== data.newUserId,
     { message: 'Cannot swap with yourself' }
   );

   export const OverrideListQuerySchema = z.object({
     scheduleId: z.string().cuid().optional(),
     userId: z.string().cuid().optional(),
     startAfter: z.string().datetime().optional(),
     endBefore: z.string().datetime().optional(),
   });
   ```

2. Export TypeScript types:
   ```typescript
   export type CreateOverrideInput = z.infer<typeof CreateOverrideInputSchema>;
   export type CreateSwapInput = z.infer<typeof CreateSwapInputSchema>;
   export type OverrideListQuery = z.infer<typeof OverrideListQuerySchema>;
   ```

3. Add interface for override with users:
   ```typescript
   export interface OverrideWithUsers {
     id: string;
     scheduleId: string;
     userId: string;
     originalUserId: string | null;
     startTime: Date;
     endTime: Date;
     reason: string | null;
     overrideType: string;
     createdById: string;
     createdAt: Date;
     user: { id: string; firstName: string; lastName: string; email: string };
     originalUser?: { id: string; firstName: string; lastName: string; email: string } | null;
     createdBy: { id: string; firstName: string; lastName: string };
     schedule?: { id: string; name: string; teamId: string };
   }
   ```
  </action>
  <verify>Run `npm run build` - TypeScript should compile without errors</verify>
  <done>Override types added with validation for time ranges and swap constraints</done>
</task>

<task type="auto">
  <name>Task 2: Create schedule override service with conflict detection</name>
  <files>src/services/scheduleOverride.service.ts</files>
  <action>
Create src/services/scheduleOverride.service.ts with ScheduleOverrideService class:

1. Import dependencies:
   - PrismaClient
   - DateTime from luxon
   - Types from schedule types
   - AuditService for logging

2. Private helper: checkOverlapConflict(scheduleId, startTime, endTime, excludeId?) method:
   ```typescript
   private async checkOverlapConflict(
     tx: Prisma.TransactionClient,
     scheduleId: string,
     startTime: Date,
     endTime: Date,
     excludeId?: string
   ): Promise<ScheduleOverride | null> {
     const where: Prisma.ScheduleOverrideWhereInput = {
       scheduleId,
       OR: [
         // New override starts during existing
         { startTime: { lte: startTime }, endTime: { gt: startTime } },
         // New override ends during existing
         { startTime: { lt: endTime }, endTime: { gte: endTime } },
         // New override contains existing
         { startTime: { gte: startTime }, endTime: { lte: endTime } },
       ],
     };
     if (excludeId) {
       where.id = { not: excludeId };
     }
     return tx.scheduleOverride.findFirst({ where });
   }
   ```

3. createOverride(input, userId) method:
   - Use Prisma transaction for atomicity
   - Load schedule to get teamId and timezone
   - Validate user is a member of schedule's team
   - Parse times in schedule's timezone
   - Check for overlapping overrides using helper
   - If overlap found, throw error with conflict details
   - Create override with overrideType = 'manual'
   - Audit log: schedule.override.created
   - Return override with users included

4. createSwap(input, userId) method:
   - Use Prisma transaction for atomicity
   - Load schedule to get teamId
   - Validate both originalUserId and newUserId are team members
   - Check for overlapping overrides
   - Create override with:
     - userId = input.newUserId
     - originalUserId = input.originalUserId
     - overrideType = 'swap'
     - reason = input.reason or "Shift swap"
   - Audit log: schedule.shift.swapped with metadata including both users
   - Return override with users included

5. findBySchedule(scheduleId, query) method:
   - Find all overrides for a schedule
   - Filter by startAfter/endBefore if provided
   - Include user and originalUser relations
   - Order by startTime ASC

6. findById(id) method:
   - Find override with all user relations
   - Return null if not found

7. findUpcoming(userId) method:
   - Find user's upcoming overrides (startTime > now)
   - Include schedule relation
   - Order by startTime ASC

8. delete(id, userId) method:
   - Load override with schedule for context
   - Permission check: must be createdBy or team admin
   - Hard delete override
   - Audit log: schedule.override.deleted

9. deleteExpired() method (for cleanup job):
   - Delete overrides where endTime < now - 30 days
   - Return count of deleted records
  </action>
  <verify>Run `npm run build` - TypeScript should compile without errors</verify>
  <done>ScheduleOverrideService created with conflict detection and swap workflow</done>
</task>

<task type="auto">
  <name>Task 3: Create override routes and mount to app</name>
  <files>src/routes/scheduleOverride.routes.ts, src/index.ts</files>
  <action>
Create src/routes/scheduleOverride.routes.ts with Express router:

1. Define routes nested under schedules:

POST /api/schedules/:scheduleId/overrides
- Auth: requireAuth
- Body validation: CreateOverrideInputSchema
- Permission: Team admin or responder on schedule's team
- Set scheduleId from params
- Call ScheduleOverrideService.createOverride(input, req.user.id)
- Return 201 with created override
- Return 409 Conflict if overlap detected

POST /api/schedules/:scheduleId/swaps
- Auth: requireAuth
- Body validation: CreateSwapInputSchema
- Permission: Must be the originalUserId OR team admin
- Set scheduleId from params
- Call ScheduleOverrideService.createSwap(input, req.user.id)
- Return 201 with created swap override
- Return 409 Conflict if overlap detected

GET /api/schedules/:scheduleId/overrides
- Auth: requireAuth
- Query validation: OverrideListQuerySchema
- Call ScheduleOverrideService.findBySchedule(scheduleId, query)
- Return 200 with overrides array

GET /api/schedules/:scheduleId/overrides/:overrideId
- Auth: requireAuth
- Call ScheduleOverrideService.findById(overrideId)
- Verify override.scheduleId matches params
- Return 404 if not found
- Return 200 with override

DELETE /api/schedules/:scheduleId/overrides/:overrideId
- Auth: requireAuth
- Permission: Must be createdBy or team admin
- Call ScheduleOverrideService.delete(overrideId, req.user.id)
- Return 204 No Content

GET /api/users/me/overrides/upcoming
- Auth: requireAuth
- Call ScheduleOverrideService.findUpcoming(req.user.id)
- Return 200 with user's upcoming overrides

Update src/index.ts:
- Import override routes
- Mount at /api/schedules (routes handle nested paths)
- Mount /api/users/me/overrides separately
  </action>
  <verify>Run `npm run build` and start server. Test with curl:
- Create schedule with users in rotation
- POST override for user A to cover user B's shift
- POST swap where user B takes user A's shift
- Attempt overlapping override - should get 409 Conflict
- GET overrides should show both
</verify>
  <done>Override routes created with conflict detection and swap endpoint</done>
</task>

</tasks>

<verification>
1. Run `npm run build` - TypeScript compiles without errors
2. Run `npm run dev` and test endpoints:
   - POST override returns 201
   - POST swap returns 201 with overrideType = 'swap'
   - POST overlapping override returns 409 Conflict
   - GET overrides returns list with users populated
   - DELETE removes override
   - GET /api/users/me/overrides/upcoming returns user's overrides
3. Verify conflict detection:
   - Override from 9 AM to 5 PM exists
   - Try override from 2 PM to 6 PM - should conflict
   - Try override from 5 PM to 9 PM - should succeed (no overlap)
4. Verify swap validation:
   - Both users must be team members
   - Cannot swap with yourself
5. Verify audit logs for override operations
</verification>

<success_criteria>
- Override types with conflict detection validation exist
- ScheduleOverrideService handles overrides and swaps
- Overlapping overrides are rejected with 409 Conflict
- Swap workflow validates both users are team members
- Swaps record both originalUserId and newUserId
- API routes enforce RBAC appropriately
- Users can view their upcoming overrides
</success_criteria>

<output>
After completion, create `.planning/phases/03-scheduling-system/03-04-SUMMARY.md`
</output>
