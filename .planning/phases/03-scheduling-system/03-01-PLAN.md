---
phase: 03-scheduling-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
autonomous: true

must_haves:
  truths:
    - "Schedule model exists with RRULE-based recurrence storage"
    - "ScheduleLayer model supports multi-layer priority precedence"
    - "ScheduleOverride model handles temporary coverage changes"
    - "CalendarSync model stores OAuth tokens for calendar integrations"
    - "All timestamps use @db.Timestamptz for UTC storage"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Schedule, ScheduleLayer, ScheduleOverride, CalendarSync models"
      contains: "model Schedule"
  key_links:
    - from: "Schedule"
      to: "Team"
      via: "teamId foreign key"
      pattern: "teamId.*String"
    - from: "ScheduleLayer"
      to: "Schedule"
      via: "scheduleId foreign key"
      pattern: "scheduleId.*String"
    - from: "ScheduleOverride"
      to: "Schedule, User"
      via: "scheduleId, userId foreign keys"
      pattern: "(scheduleId|userId).*String"
---

<objective>
Add database models for on-call scheduling system to support daily, weekly, and custom rotations with timezone-aware storage.

Purpose: Establish the data foundation for the scheduling system, enabling Phase 3 features to build on solid schema with proper RRULE storage, layer precedence, and override tracking.

Output: Extended Prisma schema with Schedule, ScheduleLayer, ScheduleOverride, and CalendarSync models with proper indexes and relations.
</objective>

<execution_context>
@/Users/tvellore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tvellore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-scheduling-system/03-RESEARCH.md
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Schedule and ScheduleLayer models</name>
  <files>prisma/schema.prisma</files>
  <action>
Add the Schedule model with the following fields:
- id: String @id @default(cuid())
- teamId: String (relation to Team)
- name: String
- description: String?
- timezone: String (IANA timezone e.g., "America/New_York")
- startDate: DateTime @db.Timestamptz
- endDate: DateTime? @db.Timestamptz
- handoffTime: String (HH:MM format e.g., "09:00")
- rotationType: String (daily, weekly, custom)
- rotationIntervalDays: Int @default(7) (for custom rotations)
- recurrenceRule: String (RRULE format from rrule library)
- rotationUserIds: String[] (ordered list of users in rotation)
- isActive: Boolean @default(true)
- createdAt: DateTime @default(now()) @db.Timestamptz
- updatedAt: DateTime @updatedAt @db.Timestamptz

Add relations:
- team: Team @relation(fields: [teamId], references: [id])
- layers: ScheduleLayer[]
- overrides: ScheduleOverride[]

Add indexes:
- @@index([teamId])
- @@index([isActive])

Add the ScheduleLayer model with the following fields:
- id: String @id @default(cuid())
- scheduleId: String (relation to Schedule)
- name: String (e.g., "Primary", "Backup", "Weekend")
- priority: Int (higher number = higher precedence)
- timezone: String (IANA timezone)
- startDate: DateTime @db.Timestamptz
- endDate: DateTime? @db.Timestamptz
- handoffTime: String
- recurrenceRule: String
- rotationUserIds: String[]
- restrictions: Json? (e.g., {"daysOfWeek": ["SAT", "SUN"]})
- isActive: Boolean @default(true)
- createdAt: DateTime @default(now()) @db.Timestamptz
- updatedAt: DateTime @updatedAt @db.Timestamptz

Add relations:
- schedule: Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

Add indexes:
- @@index([scheduleId, priority])
- @@index([scheduleId, isActive])

Update Team model to add schedules relation:
- schedules: Schedule[]

NOTE: Store IANA timezone names (e.g., "America/New_York"), NOT abbreviations (EST) or offsets (-05:00). Per research, abbreviations break during DST transitions.
  </action>
  <verify>Run `npx prisma validate` - should pass with no errors</verify>
  <done>Schedule and ScheduleLayer models added to schema with proper relations and indexes</done>
</task>

<task type="auto">
  <name>Task 2: Add ScheduleOverride and CalendarSync models</name>
  <files>prisma/schema.prisma</files>
  <action>
Add the ScheduleOverride model with the following fields:
- id: String @id @default(cuid())
- scheduleId: String (relation to Schedule)
- userId: String (who is covering)
- originalUserId: String? (who was originally scheduled, for shift swaps)
- startTime: DateTime @db.Timestamptz
- endTime: DateTime @db.Timestamptz
- reason: String? (e.g., "Vacation coverage", "Shift swap with John")
- overrideType: String @default("manual") (manual, swap)
- createdById: String
- createdAt: DateTime @default(now()) @db.Timestamptz

Add relations:
- schedule: Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
- user: User @relation("ScheduleOverrideUser", fields: [userId], references: [id])
- originalUser: User? @relation("ScheduleOverrideOriginalUser", fields: [originalUserId], references: [id])
- createdBy: User @relation("ScheduleOverrideCreatedBy", fields: [createdById], references: [id])

Add indexes:
- @@index([scheduleId, startTime, endTime])
- @@index([userId])
- @@index([scheduleId])

Add the CalendarSync model with the following fields:
- id: String @id @default(cuid())
- userId: String (relation to User)
- provider: String (google, microsoft)
- accessToken: String (encrypted in production)
- refreshToken: String (encrypted in production)
- tokenExpiresAt: DateTime @db.Timestamptz
- calendarId: String (external calendar ID to sync to)
- calendarName: String?
- isActive: Boolean @default(true)
- syncedUntil: DateTime? @db.Timestamptz (last synced shift end)
- lastSyncAt: DateTime? @db.Timestamptz
- lastSyncError: String?
- createdAt: DateTime @default(now()) @db.Timestamptz
- updatedAt: DateTime @updatedAt @db.Timestamptz

Add relations:
- user: User @relation(fields: [userId], references: [id], onDelete: Cascade)

Add indexes and constraints:
- @@unique([userId, provider])
- @@index([isActive, syncedUntil])

Update User model to add new relations:
- scheduleOverridesAsUser: ScheduleOverride[] @relation("ScheduleOverrideUser")
- scheduleOverridesAsOriginal: ScheduleOverride[] @relation("ScheduleOverrideOriginalUser")
- scheduleOverridesCreated: ScheduleOverride[] @relation("ScheduleOverrideCreatedBy")
- calendarSyncs: CalendarSync[]
  </action>
  <verify>Run `npx prisma validate` - should pass with no errors</verify>
  <done>ScheduleOverride and CalendarSync models added with proper relations to User and Schedule</done>
</task>

<task type="auto">
  <name>Task 3: Apply database migration</name>
  <files>prisma/schema.prisma</files>
  <action>
Run Prisma db push to apply schema changes to database:

```bash
npx prisma db push
```

Then generate the Prisma client:

```bash
npx prisma generate
```

Verify the models are accessible by checking that TypeScript recognizes them:
- prisma.schedule
- prisma.scheduleLayer
- prisma.scheduleOverride
- prisma.calendarSync
  </action>
  <verify>Run `npx prisma db push` and `npx prisma generate` - both should succeed. Then run `npm run build` to verify TypeScript compilation.</verify>
  <done>Database schema updated and Prisma client regenerated with new schedule models</done>
</task>

</tasks>

<verification>
1. Run `npx prisma validate` - schema should be valid
2. Run `npx prisma db push` - migration should apply successfully
3. Run `npm run build` - TypeScript should compile with new types
4. Verify models in schema: Schedule, ScheduleLayer, ScheduleOverride, CalendarSync
5. Verify all timestamp fields use @db.Timestamptz
6. Verify timezone fields accept IANA timezone names (stored as String)
</verification>

<success_criteria>
- Schema validates without errors
- Database migration applies successfully
- Prisma client generates with schedule types
- TypeScript compilation passes
- All four schedule-related models exist with proper relations
</success_criteria>

<output>
After completion, create `.planning/phases/03-scheduling-system/03-01-SUMMARY.md`
</output>
