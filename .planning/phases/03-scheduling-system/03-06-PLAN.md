---
phase: 03-scheduling-system
plan: 06
type: execute
wave: 4
depends_on: ["03-05"]
files_modified:
  - src/services/calendarSync.service.ts
  - src/routes/calendarSync.routes.ts
  - src/index.ts
  - src/config/env.ts
  - package.json
autonomous: false
user_setup:
  - service: google
    why: "Google Calendar integration for syncing on-call shifts"
    env_vars:
      - name: GOOGLE_CLIENT_ID
        source: "Google Cloud Console -> APIs & Services -> Credentials"
      - name: GOOGLE_CLIENT_SECRET
        source: "Google Cloud Console -> APIs & Services -> Credentials"
    dashboard_config:
      - task: "Create OAuth 2.0 Client ID"
        location: "Google Cloud Console -> APIs & Services -> Credentials"
      - task: "Enable Google Calendar API"
        location: "Google Cloud Console -> APIs & Services -> Library"
      - task: "Add redirect URI: {BASE_URL}/api/calendar/google/callback"
        location: "Google Cloud Console -> OAuth consent screen"
  - service: microsoft
    why: "Outlook Calendar integration for syncing on-call shifts"
    env_vars:
      - name: MICROSOFT_CLIENT_ID
        source: "Azure Portal -> App registrations -> Overview"
      - name: MICROSOFT_CLIENT_SECRET
        source: "Azure Portal -> App registrations -> Certificates & secrets"
      - name: MICROSOFT_TENANT_ID
        source: "Azure Portal -> App registrations -> Overview"
    dashboard_config:
      - task: "Register application"
        location: "Azure Portal -> App registrations"
      - task: "Add Calendars.ReadWrite permission"
        location: "Azure Portal -> API permissions"
      - task: "Add redirect URI: {BASE_URL}/api/calendar/microsoft/callback"
        location: "Azure Portal -> Authentication"

must_haves:
  truths:
    - "User can connect Google Calendar for shift sync (SCHED-08)"
    - "User can connect Outlook Calendar for shift sync (SCHED-09)"
    - "OAuth tokens stored securely with refresh capability"
    - "Shifts sync one-way from system to calendar"
  artifacts:
    - path: "src/services/calendarSync.service.ts"
      provides: "CalendarSyncService with OAuth and event sync"
      exports: ["CalendarSyncService"]
    - path: "src/routes/calendarSync.routes.ts"
      provides: "Calendar OAuth and sync API routes"
      min_lines: 80
  key_links:
    - from: "src/services/calendarSync.service.ts"
      to: "googleapis"
      via: "google.calendar API calls"
      pattern: "google\\.calendar|googleapis"
    - from: "src/services/calendarSync.service.ts"
      to: "@microsoft/microsoft-graph-client"
      via: "Microsoft Graph API calls"
      pattern: "Client\\.init|graph"
---

<objective>
Implement calendar integration allowing users to sync their on-call shifts to Google Calendar and Outlook Calendar.

Purpose: Enable users to see their on-call shifts in their personal calendars for better visibility and planning (SCHED-08, SCHED-09).

Output: CalendarSyncService with OAuth flows and event synchronization, plus API routes for connection management.
</objective>

<execution_context>
@/Users/tvellore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tvellore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-scheduling-system/03-RESEARCH.md
@.planning/phases/03-scheduling-system/03-05-SUMMARY.md
@prisma/schema.prisma
@src/services/oncall.service.ts
@src/config/env.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and configure OAuth environment</name>
  <files>package.json, src/config/env.ts</files>
  <action>
Install required dependencies:
```bash
npm install googleapis @microsoft/microsoft-graph-client @azure/identity
```

Update src/config/env.ts to add optional calendar OAuth configuration:

```typescript
// Add to existing schema (all optional for development)
GOOGLE_CLIENT_ID: z.string().optional(),
GOOGLE_CLIENT_SECRET: z.string().optional(),
MICROSOFT_CLIENT_ID: z.string().optional(),
MICROSOFT_CLIENT_SECRET: z.string().optional(),
MICROSOFT_TENANT_ID: z.string().optional(),
```

Add helper to check if calendar integrations are configured:
```typescript
export const isGoogleCalendarConfigured = () =>
  Boolean(env.GOOGLE_CLIENT_ID && env.GOOGLE_CLIENT_SECRET);

export const isMicrosoftCalendarConfigured = () =>
  Boolean(env.MICROSOFT_CLIENT_ID && env.MICROSOFT_CLIENT_SECRET && env.MICROSOFT_TENANT_ID);
```

Update .env.example with calendar OAuth placeholders:
```
# Calendar Integration (optional)
GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=
MICROSOFT_CLIENT_ID=
MICROSOFT_CLIENT_SECRET=
MICROSOFT_TENANT_ID=
```
  </action>
  <verify>Run `npm run build` - TypeScript should compile without errors</verify>
  <done>Calendar OAuth dependencies installed and environment configuration added</done>
</task>

<task type="auto">
  <name>Task 2: Create calendar sync service with OAuth and sync logic</name>
  <files>src/services/calendarSync.service.ts</files>
  <action>
Create src/services/calendarSync.service.ts with CalendarSyncService class:

1. Import dependencies:
   - google from googleapis
   - Client from @microsoft/microsoft-graph-client
   - ClientSecretCredential from @azure/identity
   - PrismaClient, DateTime
   - OnCallService for shift data
   - env helpers for config check

2. Google OAuth methods:
   ```typescript
   getGoogleAuthUrl(userId: string, redirectUri: string): string {
     if (!isGoogleCalendarConfigured()) {
       throw new Error('Google Calendar not configured');
     }
     const oauth2Client = new google.auth.OAuth2(
       env.GOOGLE_CLIENT_ID,
       env.GOOGLE_CLIENT_SECRET,
       redirectUri
     );
     return oauth2Client.generateAuthUrl({
       access_type: 'offline',
       scope: ['https://www.googleapis.com/auth/calendar.events'],
       state: userId, // Pass userId through OAuth flow
       prompt: 'consent', // Force refresh token
     });
   }

   async handleGoogleCallback(code: string, userId: string, redirectUri: string): Promise<CalendarSync> {
     const oauth2Client = new google.auth.OAuth2(
       env.GOOGLE_CLIENT_ID,
       env.GOOGLE_CLIENT_SECRET,
       redirectUri
     );
     const { tokens } = await oauth2Client.getToken(code);

     // Get calendar list to find primary calendar
     oauth2Client.setCredentials(tokens);
     const calendar = google.calendar({ version: 'v3', auth: oauth2Client });
     const calendarList = await calendar.calendarList.list();
     const primaryCalendar = calendarList.data.items?.find(c => c.primary) || calendarList.data.items?.[0];

     // Store in database
     return await this.prisma.calendarSync.upsert({
       where: { userId_provider: { userId, provider: 'google' } },
       create: {
         userId,
         provider: 'google',
         accessToken: tokens.access_token!,
         refreshToken: tokens.refresh_token!,
         tokenExpiresAt: new Date(tokens.expiry_date!),
         calendarId: primaryCalendar?.id || 'primary',
         calendarName: primaryCalendar?.summary || 'Primary',
         isActive: true,
       },
       update: {
         accessToken: tokens.access_token!,
         refreshToken: tokens.refresh_token || undefined, // Refresh token not always returned
         tokenExpiresAt: new Date(tokens.expiry_date!),
         calendarId: primaryCalendar?.id || 'primary',
         calendarName: primaryCalendar?.summary || 'Primary',
         isActive: true,
         lastSyncError: null,
       },
     });
   }
   ```

3. Microsoft OAuth methods (similar pattern):
   ```typescript
   getMicrosoftAuthUrl(userId: string, redirectUri: string): string
   async handleMicrosoftCallback(code: string, userId: string, redirectUri: string): Promise<CalendarSync>
   ```

4. Token refresh helpers:
   ```typescript
   private async refreshGoogleToken(sync: CalendarSync): Promise<string>
   private async refreshMicrosoftToken(sync: CalendarSync): Promise<string>
   private async getValidAccessToken(sync: CalendarSync): Promise<string>
   ```

5. Sync methods:
   ```typescript
   async syncUserShifts(userId: string, days: number = 30): Promise<{ created: number; deleted: number }> {
     const syncs = await this.prisma.calendarSync.findMany({
       where: { userId, isActive: true },
     });

     let totalCreated = 0, totalDeleted = 0;

     for (const sync of syncs) {
       try {
         const accessToken = await this.getValidAccessToken(sync);
         const shifts = await this.onCallService.getUpcomingShifts(userId, days);

         if (sync.provider === 'google') {
           const result = await this.syncToGoogle(sync, accessToken, shifts);
           totalCreated += result.created;
           totalDeleted += result.deleted;
         } else if (sync.provider === 'microsoft') {
           const result = await this.syncToMicrosoft(sync, accessToken, shifts);
           totalCreated += result.created;
           totalDeleted += result.deleted;
         }

         // Update sync state
         await this.prisma.calendarSync.update({
           where: { id: sync.id },
           data: {
             lastSyncAt: new Date(),
             syncedUntil: DateTime.now().plus({ days }).toJSDate(),
             lastSyncError: null,
           },
         });
       } catch (error) {
         await this.prisma.calendarSync.update({
           where: { id: sync.id },
           data: { lastSyncError: error.message },
         });
       }
     }

     return { created: totalCreated, deleted: totalDeleted };
   }
   ```

6. Private sync helpers:
   ```typescript
   private async syncToGoogle(sync: CalendarSync, accessToken: string, shifts: Shift[]): Promise<{ created: number; deleted: number }>
   private async syncToMicrosoft(sync: CalendarSync, accessToken: string, shifts: Shift[]): Promise<{ created: number; deleted: number }>
   ```

7. Management methods:
   ```typescript
   async getUserConnections(userId: string): Promise<CalendarSync[]>
   async disconnectProvider(userId: string, provider: string): Promise<void>
   ```
  </action>
  <verify>Run `npm run build` - TypeScript should compile without errors</verify>
  <done>CalendarSyncService created with OAuth flows and sync logic for both providers</done>
</task>

<task type="auto">
  <name>Task 3: Create calendar routes and mount to app</name>
  <files>src/routes/calendarSync.routes.ts, src/index.ts</files>
  <action>
Create src/routes/calendarSync.routes.ts with Express router:

1. OAuth initiation routes:

GET /api/calendar/google/connect
- Auth: requireAuth
- Check if Google Calendar is configured
- Generate OAuth URL with user ID in state
- Redirect user to Google OAuth page

GET /api/calendar/google/callback
- Handle OAuth callback (may not have session if redirect)
- Extract userId from state parameter
- Call CalendarSyncService.handleGoogleCallback
- Redirect to frontend with success/error status

GET /api/calendar/microsoft/connect
- Auth: requireAuth
- Check if Microsoft Calendar is configured
- Generate OAuth URL with user ID in state
- Redirect user to Microsoft OAuth page

GET /api/calendar/microsoft/callback
- Handle OAuth callback
- Extract userId from state parameter
- Call CalendarSyncService.handleMicrosoftCallback
- Redirect to frontend with success/error status

2. Management routes:

GET /api/calendar/connections
- Auth: requireAuth
- Call CalendarSyncService.getUserConnections(req.user.id)
- Return 200 with connections (hide tokens, show status)

POST /api/calendar/sync
- Auth: requireAuth
- Query: days?: number (default 30)
- Call CalendarSyncService.syncUserShifts(req.user.id, days)
- Return 200 with { created, deleted } counts

DELETE /api/calendar/:provider
- Auth: requireAuth
- provider must be 'google' or 'microsoft'
- Call CalendarSyncService.disconnectProvider(req.user.id, provider)
- Return 204 No Content

GET /api/calendar/status
- Auth: none (for frontend to check availability)
- Return which providers are configured:
  { google: boolean, microsoft: boolean }

Update src/index.ts:
- Import calendar routes
- Mount at /api/calendar
  </action>
  <verify>Run `npm run build` and start server. Verify routes registered.</verify>
  <done>Calendar routes created for OAuth flows and sync management</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Calendar integration with Google and Outlook OAuth flows</what-built>
  <how-to-verify>
1. Configure Google OAuth (if available):
   - Set GOOGLE_CLIENT_ID and GOOGLE_CLIENT_SECRET in .env
   - Visit GET /api/calendar/google/connect (while logged in)
   - Complete OAuth flow
   - Verify connection appears in GET /api/calendar/connections

2. Configure Microsoft OAuth (if available):
   - Set MICROSOFT_CLIENT_ID, MICROSOFT_CLIENT_SECRET, MICROSOFT_TENANT_ID in .env
   - Visit GET /api/calendar/microsoft/connect (while logged in)
   - Complete OAuth flow
   - Verify connection appears in GET /api/calendar/connections

3. Test sync (requires schedule with user in rotation):
   - POST /api/calendar/sync
   - Verify events created in connected calendar
   - Check calendar for "On-Call: {Team Name}" events

4. Test disconnect:
   - DELETE /api/calendar/google
   - Verify connection removed from list

Note: If OAuth credentials not available, verify routes are registered and return appropriate "not configured" errors.
  </how-to-verify>
  <resume-signal>Type "approved" if calendar integration works, or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Run `npm run build` - TypeScript compiles without errors
2. Run `npm run dev` and verify routes registered
3. GET /api/calendar/status returns provider availability
4. OAuth flows redirect correctly (or return "not configured" error)
5. Connected calendars listed in GET /api/calendar/connections
6. POST /api/calendar/sync creates events in calendar
7. Disconnect removes connection and stops sync
</verification>

<success_criteria>
- googleapis and Microsoft Graph dependencies installed
- OAuth environment configuration added (all optional)
- CalendarSyncService handles OAuth for both providers
- Token refresh logic prevents expired token errors
- Shifts sync one-way from system to calendar
- Calendar events include schedule name and shift times
- Users can connect, sync, and disconnect calendars
- Missing OAuth credentials return clear error message
</success_criteria>

<output>
After completion, create `.planning/phases/03-scheduling-system/03-06-SUMMARY.md`
</output>
