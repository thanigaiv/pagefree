---
phase: 10-postmortems
plan: 06
type: execute
wave: 5
depends_on: ["10-05"]
files_modified:
  - frontend/src/pages/PostmortemsPage.tsx
  - frontend/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can see list of postmortems"
    - "User can create new postmortem with incident linking"
    - "User can filter postmortems by team"
    - "Navigation to postmortem detail works"
  artifacts:
    - path: "frontend/src/pages/PostmortemsPage.tsx"
      provides: "Postmortem list and create UI"
      min_lines: 150
  key_links:
    - from: "frontend/src/pages/PostmortemsPage.tsx"
      to: "frontend/src/hooks/usePostmortems.ts"
      via: "Hook imports"
      pattern: "usePostmortems|useCreatePostmortem"
    - from: "frontend/src/App.tsx"
      to: "frontend/src/pages/PostmortemsPage.tsx"
      via: "Route definition"
      pattern: "PostmortemsPage"
---

<objective>
Create postmortems list page with team filtering and create dialog.

Purpose: Enable users to view, filter, and create postmortems from a central list page.

Output: PostmortemsPage component with list, filters, and create modal.
</objective>

<execution_context>
@/Users/tvellore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tvellore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-postmortems/10-RESEARCH.md

Key patterns:
- Page pattern from frontend/src/pages/StatusPagesPage.tsx
- Dialog pattern for create form
- Team select using useTeams hook
- Card-based list layout

@frontend/src/pages/StatusPagesPage.tsx - Page layout pattern
@frontend/src/hooks/useTeams.ts - Team selection
@frontend/src/hooks/useIncidents.ts - Incident selection for linking
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PostmortemsPage component</name>
  <files>frontend/src/pages/PostmortemsPage.tsx</files>
  <action>
Create new page following StatusPagesPage pattern:

```typescript
import { useState } from 'react';
import { Link } from 'react-router-dom';
import { Plus, FileText, Clock, Users, CheckCircle2 } from 'lucide-react';
import { formatDistanceToNow } from 'date-fns';

import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
  DialogFooter
} from '@/components/ui/dialog';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue
} from '@/components/ui/select';
import { Badge } from '@/components/ui/badge';
import { Skeleton } from '@/components/ui/skeleton';
import { useToast } from '@/hooks/use-toast';

import { usePostmortems, useCreatePostmortem } from '@/hooks/usePostmortems';
import { useTeams } from '@/hooks/useTeams';
import { useIncidents } from '@/hooks/useIncidents';
import type { CreatePostmortemInput, Postmortem, ActionItem } from '@/types/postmortem';

export default function PostmortemsPage() {
  const [teamFilter, setTeamFilter] = useState<string>('');
  const [createDialogOpen, setCreateDialogOpen] = useState(false);
  const { toast } = useToast();

  const { data: postmortems, isLoading } = usePostmortems(teamFilter || undefined);
  const { data: teams } = useTeams();

  // Create form state
  const [newPostmortem, setNewPostmortem] = useState<CreatePostmortemInput>({
    title: '',
    incidentIds: [],
    teamId: ''
  });
  const createMutation = useCreatePostmortem();

  // Get incidents for linking (recent resolved/closed)
  const { data: incidents } = useIncidents({
    status: 'RESOLVED',
    limit: 50
  });

  const handleCreate = async () => {
    if (!newPostmortem.title || !newPostmortem.teamId || newPostmortem.incidentIds.length === 0) {
      toast({
        title: 'Missing required fields',
        description: 'Please provide a title, team, and at least one incident',
        variant: 'destructive'
      });
      return;
    }

    try {
      await createMutation.mutateAsync(newPostmortem);
      toast({ title: 'Postmortem created' });
      setCreateDialogOpen(false);
      setNewPostmortem({ title: '', incidentIds: [], teamId: '' });
    } catch (error) {
      toast({
        title: 'Failed to create postmortem',
        description: error instanceof Error ? error.message : 'Unknown error',
        variant: 'destructive'
      });
    }
  };

  const getStatusBadge = (status: string) => {
    if (status === 'PUBLISHED') {
      return <Badge className="bg-green-100 text-green-800">Published</Badge>;
    }
    return <Badge variant="secondary">Draft</Badge>;
  };

  const getActionItemStats = (actionItems?: ActionItem[]) => {
    if (!actionItems || actionItems.length === 0) return null;
    const completed = actionItems.filter(a => a.status === 'COMPLETED').length;
    const total = actionItems.length;
    return (
      <span className="flex items-center gap-1 text-xs text-muted-foreground">
        <CheckCircle2 className="h-3 w-3" />
        {completed}/{total} actions
      </span>
    );
  };

  return (
    <div className="container mx-auto py-6 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold">Postmortems</h1>
          <p className="text-muted-foreground">
            Review incident postmortems and track action items
          </p>
        </div>

        <Dialog open={createDialogOpen} onOpenChange={setCreateDialogOpen}>
          <DialogTrigger asChild>
            <Button>
              <Plus className="h-4 w-4 mr-2" />
              New Postmortem
            </Button>
          </DialogTrigger>
          <DialogContent className="max-w-md">
            <DialogHeader>
              <DialogTitle>Create Postmortem</DialogTitle>
            </DialogHeader>
            <div className="space-y-4 py-4">
              <div className="space-y-2">
                <Label htmlFor="title">Title</Label>
                <Input
                  id="title"
                  placeholder="e.g., API Outage - Feb 7, 2026"
                  value={newPostmortem.title}
                  onChange={e =>
                    setNewPostmortem(p => ({ ...p, title: e.target.value }))
                  }
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="team">Team</Label>
                <Select
                  value={newPostmortem.teamId}
                  onValueChange={v => setNewPostmortem(p => ({ ...p, teamId: v }))}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Select team" />
                  </SelectTrigger>
                  <SelectContent>
                    {teams?.map(team => (
                      <SelectItem key={team.id} value={team.id}>
                        {team.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-2">
                <Label>Linked Incidents</Label>
                <p className="text-xs text-muted-foreground mb-2">
                  Select one or more resolved incidents
                </p>
                <div className="max-h-48 overflow-y-auto border rounded-md p-2 space-y-1">
                  {incidents?.data?.map(incident => (
                    <label
                      key={incident.id}
                      className="flex items-center gap-2 p-2 hover:bg-muted rounded cursor-pointer"
                    >
                      <input
                        type="checkbox"
                        checked={newPostmortem.incidentIds.includes(incident.id)}
                        onChange={e => {
                          if (e.target.checked) {
                            setNewPostmortem(p => ({
                              ...p,
                              incidentIds: [...p.incidentIds, incident.id]
                            }));
                          } else {
                            setNewPostmortem(p => ({
                              ...p,
                              incidentIds: p.incidentIds.filter(id => id !== incident.id)
                            }));
                          }
                        }}
                        className="rounded"
                      />
                      <div className="flex-1 min-w-0">
                        <p className="text-sm font-medium truncate">
                          {incident.alerts?.[0]?.title || `Incident ${incident.id.slice(-6)}`}
                        </p>
                        <p className="text-xs text-muted-foreground">
                          {formatDistanceToNow(new Date(incident.createdAt), {
                            addSuffix: true
                          })}
                        </p>
                      </div>
                    </label>
                  )) || (
                    <p className="text-sm text-muted-foreground p-2">
                      No resolved incidents found
                    </p>
                  )}
                </div>
                {newPostmortem.incidentIds.length > 0 && (
                  <p className="text-xs text-muted-foreground">
                    {newPostmortem.incidentIds.length} incident(s) selected
                  </p>
                )}
              </div>
            </div>
            <DialogFooter>
              <Button variant="outline" onClick={() => setCreateDialogOpen(false)}>
                Cancel
              </Button>
              <Button onClick={handleCreate} disabled={createMutation.isPending}>
                {createMutation.isPending ? 'Creating...' : 'Create'}
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      </div>

      {/* Filters */}
      <div className="flex gap-4">
        <Select value={teamFilter} onValueChange={setTeamFilter}>
          <SelectTrigger className="w-48">
            <SelectValue placeholder="All teams" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="">All teams</SelectItem>
            {teams?.map(team => (
              <SelectItem key={team.id} value={team.id}>
                {team.name}
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>

      {/* List */}
      {isLoading ? (
        <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
          {[1, 2, 3].map(i => (
            <Skeleton key={i} className="h-32" />
          ))}
        </div>
      ) : postmortems?.length === 0 ? (
        <Card>
          <CardContent className="flex flex-col items-center justify-center py-12">
            <FileText className="h-12 w-12 text-muted-foreground mb-4" />
            <p className="text-lg font-medium">No postmortems yet</p>
            <p className="text-muted-foreground">
              Create your first postmortem to document incident learnings
            </p>
          </CardContent>
        </Card>
      ) : (
        <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
          {postmortems?.map(postmortem => (
            <Link key={postmortem.id} to={`/postmortems/${postmortem.id}`}>
              <Card className="h-full hover:border-primary transition-colors cursor-pointer">
                <CardHeader className="pb-2">
                  <div className="flex items-start justify-between gap-2">
                    <CardTitle className="text-base line-clamp-2">
                      {postmortem.title}
                    </CardTitle>
                    {getStatusBadge(postmortem.status)}
                  </div>
                </CardHeader>
                <CardContent>
                  <div className="space-y-2 text-sm">
                    <div className="flex items-center gap-2 text-muted-foreground">
                      <Users className="h-4 w-4" />
                      {postmortem.team.name}
                    </div>
                    <div className="flex items-center gap-2 text-muted-foreground">
                      <Clock className="h-4 w-4" />
                      {formatDistanceToNow(new Date(postmortem.createdAt), {
                        addSuffix: true
                      })}
                    </div>
                    <div className="flex items-center justify-between">
                      <span className="text-xs text-muted-foreground">
                        {postmortem.incidentIds.length} incident(s)
                      </span>
                      {getActionItemStats(postmortem.actionItems as ActionItem[])}
                    </div>
                  </div>
                </CardContent>
              </Card>
            </Link>
          ))}
        </div>
      )}
    </div>
  );
}
```

Key implementation details:
- Team filter with "All teams" option
- Create dialog with incident multi-select
- Card-based grid layout (responsive)
- Action item completion stats on cards
- Status badge (Draft/Published)
- Empty state with helpful message
  </action>
  <verify>Run `npm run build` in frontend/ - should compile without errors</verify>
  <done>PostmortemsPage created with list, filters, and create dialog</done>
</task>

<task type="auto">
  <name>Task 2: Add route to App.tsx</name>
  <files>frontend/src/App.tsx</files>
  <action>
Add the postmortems route to App.tsx:

1. Import the page:
   ```typescript
   import PostmortemsPage from './pages/PostmortemsPage';
   ```

2. Add route inside protected routes (with MobileLayout wrapper):
   ```tsx
   <Route path="/postmortems" element={<PostmortemsPage />} />
   ```

3. Place alongside other protected routes like /status.

Also add navigation in BottomNav.tsx or sidebar if needed - add Postmortems link with FileText icon after Status in navigation.
  </action>
  <verify>Navigate to /postmortems in browser - page renders</verify>
  <done>Route added and accessible at /postmortems</done>
</task>

<task type="auto">
  <name>Task 3: Add Postmortems to navigation</name>
  <files>frontend/src/components/BottomNav.tsx</files>
  <action>
Add Postmortems link to BottomNav.tsx:

1. Import FileText icon from lucide-react
2. Add postmortems to navItems array:
   ```typescript
   { icon: FileText, label: 'Postmortems', path: '/postmortems' }
   ```
3. Place after Status in the navigation order

Note: If BottomNav only shows 5 items, consider which items are most important for mobile. Postmortems may be less critical on mobile - could be desktop-only navigation or replace one of the less-used items. Use judgment based on existing nav items.

Alternative: If nav is full, add to desktop sidebar only and skip mobile nav.
  </action>
  <verify>Navigation shows Postmortems link, clicking navigates to /postmortems</verify>
  <done>Postmortems added to navigation</done>
</task>

</tasks>

<verification>
1. `npm run build` in frontend/ compiles without errors
2. /postmortems route renders list page
3. Team filter works
4. Create dialog opens and creates postmortem
5. Clicking postmortem card navigates to detail page (404 ok - detail page in next plan)
</verification>

<success_criteria>
- PostmortemsPage displays list of postmortems
- Team filter reduces list to selected team
- Create dialog allows selecting team and incidents
- New postmortem appears in list after creation
- Cards show title, team, status, and action item progress
</success_criteria>

<output>
After completion, create `.planning/phases/10-postmortems/10-06-SUMMARY.md`
</output>
