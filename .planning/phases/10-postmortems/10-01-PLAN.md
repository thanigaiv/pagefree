---
phase: 10-postmortems
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/types/postmortem.ts
autonomous: true

must_haves:
  truths:
    - "Postmortem model exists in database with title, content, team, and incident links"
    - "ActionItem model exists with status state machine (OPEN/IN_PROGRESS/COMPLETED)"
    - "TypeScript interfaces match Prisma schema"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Postmortem and ActionItem models"
      contains: "model Postmortem"
    - path: "src/types/postmortem.ts"
      provides: "TypeScript interfaces for postmortem domain"
      exports: ["Postmortem", "ActionItem", "PostmortemStatus", "ActionItemStatus"]
  key_links:
    - from: "src/types/postmortem.ts"
      to: "prisma/schema.prisma"
      via: "Type definitions match schema"
      pattern: "PostmortemStatus|ActionItemStatus"
---

<objective>
Create database schema and TypeScript types for postmortem functionality.

Purpose: Establish data foundation for postmortem documents with multi-incident linking and action item tracking.

Output: Prisma Postmortem and ActionItem models, TypeScript interfaces with proper types.
</objective>

<execution_context>
@/Users/tvellore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tvellore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-postmortems/10-RESEARCH.md

Key decisions from research:
- Timeline built from audit events (no separate table) - incident.note.added pattern (04-05)
- Team-based RBAC with full visibility model (01-03)
- Action items need state machine (OPEN -> IN_PROGRESS -> COMPLETED)
- incidentIds stored as String[] for multi-incident postmortems

Existing patterns:
@prisma/schema.prisma - Follow existing model patterns (cuid IDs, @db.Timestamptz, relations)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Postmortem and ActionItem models to Prisma schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add two new models at the end of schema.prisma (after Status Page models):

1. **PostmortemStatus enum:**
   - DRAFT (initial state, editable)
   - PUBLISHED (finalized, read-only except by team admin)

2. **ActionItemStatus enum:**
   - OPEN (initial state)
   - IN_PROGRESS (work started)
   - COMPLETED (done)

3. **Postmortem model:**
   - id: String @id @default(cuid())
   - title: String (required)
   - content: String @default("") (markdown content)
   - incidentIds: String[] (array of linked incident IDs for multi-incident support)
   - status: PostmortemStatus @default(DRAFT)
   - teamId: String (ownership, required)
   - team: Team relation
   - createdById: String (creator)
   - createdBy: User relation (not cascade delete - preserve for audit)
   - publishedAt: DateTime? @db.Timestamptz (when status changed to PUBLISHED)
   - createdAt: DateTime @default(now()) @db.Timestamptz
   - updatedAt: DateTime @updatedAt @db.Timestamptz
   - actionItems: ActionItem[] relation
   - Indexes: [teamId, status], [createdById]

4. **ActionItem model:**
   - id: String @id @default(cuid())
   - postmortemId: String
   - postmortem: Postmortem relation (cascade delete)
   - title: String (required, what needs to be done)
   - description: String? (optional details)
   - status: ActionItemStatus @default(OPEN)
   - priority: String @default("MEDIUM") (HIGH/MEDIUM/LOW)
   - assigneeId: String (required - every action needs owner)
   - assignee: User relation
   - dueDate: DateTime? @db.Timestamptz (optional but encouraged)
   - completedAt: DateTime? @db.Timestamptz
   - createdAt: DateTime @default(now()) @db.Timestamptz
   - updatedAt: DateTime @updatedAt @db.Timestamptz
   - Indexes: [postmortemId], [assigneeId, status]

5. **Add relations to existing models:**
   - Team: add postmortems: Postmortem[]
   - User: add postmortemsCreated: Postmortem[] @relation("PostmortemCreatedBy")
   - User: add actionItemsAssigned: ActionItem[]

Use existing model patterns from schema (cuid IDs, Timestamptz, relation naming).
  </action>
  <verify>Run `npx prisma validate` - should succeed with no errors</verify>
  <done>Postmortem and ActionItem models added to schema with all fields, enums, relations, and indexes</done>
</task>

<task type="auto">
  <name>Task 2: Create TypeScript interfaces</name>
  <files>src/types/postmortem.ts</files>
  <action>
Create new file with TypeScript interfaces matching Prisma schema:

```typescript
// Enums matching Prisma
export type PostmortemStatus = 'DRAFT' | 'PUBLISHED';
export type ActionItemStatus = 'OPEN' | 'IN_PROGRESS' | 'COMPLETED';
export type ActionItemPriority = 'HIGH' | 'MEDIUM' | 'LOW';

// Valid state transitions for action items
export const ACTION_ITEM_TRANSITIONS: Record<ActionItemStatus, ActionItemStatus[]> = {
  OPEN: ['IN_PROGRESS', 'COMPLETED'],
  IN_PROGRESS: ['COMPLETED', 'OPEN'], // Can reopen if blocked
  COMPLETED: ['OPEN'] // Can reopen if follow-up needed
};

// Base interfaces
export interface Postmortem {
  id: string;
  title: string;
  content: string;
  incidentIds: string[];
  status: PostmortemStatus;
  teamId: string;
  team?: { id: string; name: string };
  createdById: string;
  createdBy?: { id: string; firstName: string; lastName: string };
  publishedAt: string | null;
  createdAt: string;
  updatedAt: string;
  actionItems?: ActionItem[];
}

export interface ActionItem {
  id: string;
  postmortemId: string;
  title: string;
  description: string | null;
  status: ActionItemStatus;
  priority: ActionItemPriority;
  assigneeId: string;
  assignee?: { id: string; firstName: string; lastName: string };
  dueDate: string | null;
  completedAt: string | null;
  createdAt: string;
  updatedAt: string;
}

// Input types for API
export interface CreatePostmortemInput {
  title: string;
  content?: string;
  incidentIds: string[];
  teamId: string;
}

export interface UpdatePostmortemInput {
  title?: string;
  content?: string;
  incidentIds?: string[];
  status?: PostmortemStatus;
}

export interface CreateActionItemInput {
  title: string;
  description?: string;
  priority?: ActionItemPriority;
  assigneeId: string;
  dueDate?: string;
}

export interface UpdateActionItemInput {
  title?: string;
  description?: string;
  status?: ActionItemStatus;
  priority?: ActionItemPriority;
  assigneeId?: string;
  dueDate?: string | null;
}

// Timeline event from audit service (reuse existing structure)
export interface PostmortemTimelineEvent {
  id: string;
  action: string;
  timestamp: string;
  userId: string | null;
  user: { id: string; firstName: string; lastName: string } | null;
  metadata: Record<string, unknown>;
  incidentId: string; // Added for multi-incident context
}
```

Follow existing type patterns from src/types/ directory.
  </action>
  <verify>Run `npx tsc --noEmit` - should compile without errors</verify>
  <done>TypeScript interfaces created with proper types, state transitions, and input/output types</done>
</task>

<task type="auto">
  <name>Task 3: Run database migration</name>
  <files>prisma/migrations/</files>
  <action>
Generate and apply Prisma migration for new models:

1. Run: `npx prisma migrate dev --name add_postmortem_models`
2. Verify migration creates:
   - PostmortemStatus enum
   - ActionItemStatus enum
   - Postmortem table with all columns
   - ActionItem table with all columns
   - Foreign key constraints
   - Indexes

3. Run: `npx prisma generate` to update Prisma client
  </action>
  <verify>Migration applies successfully, `npx prisma studio` shows new tables</verify>
  <done>Database migrated with Postmortem and ActionItem tables, Prisma client regenerated</done>
</task>

</tasks>

<verification>
1. `npx prisma validate` passes
2. `npx tsc --noEmit` compiles without errors
3. `npx prisma studio` shows Postmortem and ActionItem tables
4. TypeScript types match Prisma schema field by field
</verification>

<success_criteria>
- Postmortem model in database with title, content, incidentIds[], status, team relation
- ActionItem model with status state machine and required assignee
- TypeScript interfaces exported and importable
- Database migration applied successfully
</success_criteria>

<output>
After completion, create `.planning/phases/10-postmortems/10-01-SUMMARY.md`
</output>
