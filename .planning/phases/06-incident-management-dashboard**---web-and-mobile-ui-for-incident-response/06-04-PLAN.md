---
phase: 06-incident-management-dashboard
plan: 04
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - frontend/src/components/IncidentDetail.tsx
  - frontend/src/components/IncidentTimeline.tsx
  - frontend/src/components/TimelineEvent.tsx
  - frontend/src/components/TechnicalDetails.tsx
  - frontend/src/hooks/useTimeline.ts
  - frontend/src/pages/IncidentDetailPage.tsx
autonomous: true

must_haves:
  truths:
    - "User sees complete incident timeline with all events"
    - "Timeline is virtualized for performance with 50+ events"
    - "User notes are visually distinct from system events"
    - "Raw alert payload available in collapsible Technical Details"
    - "External tool links shown based on service metadata"
  artifacts:
    - path: "frontend/src/components/IncidentTimeline.tsx"
      provides: "Virtualized timeline component"
      contains: "useVirtualizer"
    - path: "frontend/src/components/TimelineEvent.tsx"
      provides: "Individual timeline event display"
      contains: "note"
    - path: "frontend/src/components/TechnicalDetails.tsx"
      provides: "Collapsible raw payload view"
      contains: "JSON.stringify"
  key_links:
    - from: "frontend/src/components/IncidentTimeline.tsx"
      to: "@tanstack/react-virtual"
      via: "useVirtualizer hook"
      pattern: "useVirtualizer"
    - from: "frontend/src/hooks/useTimeline.ts"
      to: "/api/incidents/:id/timeline"
      via: "fetch request"
      pattern: "apiFetch.*timeline"
---

<objective>
Build the incident detail view with timeline, virtualization, and technical details.

Purpose: Show complete incident history in expandable rows and detail pages. Per user decisions: chronological list (newest first), virtualized scrolling for long timelines, user notes visually distinct, raw payload in collapsible section, external tool quick-links.

Output: Expandable incident detail with timeline, notes distinction, and technical info.
</objective>

<execution_context>
@/Users/tvellore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tvellore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-incident-management-dashboard**---web-and-mobile-ui-for-incident-response/06-CONTEXT.md
@.planning/phases/06-incident-management-dashboard**---web-and-mobile-ui-for-incident-response/06-RESEARCH.md
@.planning/phases/06-incident-management-dashboard**---web-and-mobile-ui-for-incident-response/06-01-SUMMARY.md

# Types and existing components
@frontend/src/types/incident.ts
@frontend/src/components/IncidentRow.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install TanStack Virtual and Create Timeline Hook</name>
  <files>
    frontend/package.json
    frontend/src/hooks/useTimeline.ts
  </files>
  <action>
Install TanStack Virtual:
```bash
cd frontend && npm install @tanstack/react-virtual
```

Create frontend/src/hooks/useTimeline.ts:
```typescript
import { useQuery } from '@tanstack/react-query';
import { apiFetch } from '@/lib/api';
import type { TimelineEvent } from '@/types/incident';

interface TimelineResponse {
  timeline: TimelineEvent[];
}

export function useTimeline(incidentId: string | undefined) {
  return useQuery({
    queryKey: ['incidents', incidentId, 'timeline'],
    queryFn: async () => {
      if (!incidentId) throw new Error('No incident ID');
      const response = await apiFetch<TimelineResponse>(
        `/incidents/${incidentId}/timeline`
      );
      // Return in reverse chronological order (newest first per user decision)
      return response.timeline.sort(
        (a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime()
      );
    },
    enabled: !!incidentId,
    staleTime: 30 * 1000,
  });
}

// Helper to categorize timeline events
export function categorizeEvent(action: string): 'note' | 'status' | 'assignment' | 'system' {
  if (action.includes('note')) return 'note';
  if (action.includes('acknowledged') || action.includes('resolved') || action.includes('closed')) {
    return 'status';
  }
  if (action.includes('assigned') || action.includes('reassigned')) return 'assignment';
  return 'system';
}

// Format action for display
export function formatAction(action: string): string {
  const actionMap: Record<string, string> = {
    'incident.created': 'Incident created',
    'incident.acknowledged': 'Acknowledged',
    'incident.resolved': 'Resolved',
    'incident.closed': 'Closed',
    'incident.reassigned': 'Reassigned',
    'incident.note.added': 'Note added',
    'incident.escalated': 'Escalated',
  };
  return actionMap[action] || action;
}
```
  </action>
  <verify>
grep -q "@tanstack/react-virtual" frontend/package.json
ls frontend/src/hooks/useTimeline.ts
  </verify>
  <done>
TanStack Virtual installed. Timeline hook fetches and sorts events in reverse chronological order.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TimelineEvent and Virtualized Timeline Components</name>
  <files>
    frontend/src/components/TimelineEvent.tsx
    frontend/src/components/IncidentTimeline.tsx
  </files>
  <action>
Add shadcn/ui collapsible:
```bash
cd frontend && npx shadcn@latest add collapsible avatar
```

Create frontend/src/components/TimelineEvent.tsx:
```typescript
import { formatDistanceToNow, format } from 'date-fns';
import type { TimelineEvent as TimelineEventType } from '@/types/incident';
import { categorizeEvent, formatAction } from '@/hooks/useTimeline';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { cn } from '@/lib/utils';
import {
  MessageSquare,
  CheckCircle,
  AlertCircle,
  UserPlus,
  Clock,
  ArrowRight,
} from 'lucide-react';

interface TimelineEventProps {
  event: TimelineEventType;
}

const eventIcons = {
  note: MessageSquare,
  status: CheckCircle,
  assignment: UserPlus,
  system: AlertCircle,
};

const eventColors = {
  note: 'bg-blue-100 text-blue-600 border-blue-200',
  status: 'bg-green-100 text-green-600 border-green-200',
  assignment: 'bg-purple-100 text-purple-600 border-purple-200',
  system: 'bg-gray-100 text-gray-600 border-gray-200',
};

export function TimelineEventCard({ event }: TimelineEventProps) {
  const category = categorizeEvent(event.action);
  const Icon = eventIcons[category];
  const colorClass = eventColors[category];

  const userName = event.user
    ? `${event.user.firstName} ${event.user.lastName}`
    : 'System';

  const initials = event.user
    ? `${event.user.firstName[0]}${event.user.lastName[0]}`
    : 'SY';

  // Extract note content or resolution note from metadata
  const noteContent = event.metadata?.note as string | undefined;
  const resolutionNote = event.metadata?.resolutionNote as string | undefined;
  const displayContent = noteContent || resolutionNote;

  // Extract reassignment details
  const newAssignee = event.metadata?.newAssignee as string | undefined;
  const reason = event.metadata?.reason as string | undefined;

  return (
    <div
      className={cn(
        'flex gap-3 p-4 rounded-lg border',
        // Per user decision: different background for user notes
        category === 'note' ? 'bg-blue-50/50' : 'bg-white'
      )}
    >
      {/* Icon */}
      <div className={cn('p-2 rounded-full h-fit', colorClass)}>
        <Icon className="h-4 w-4" />
      </div>

      {/* Content */}
      <div className="flex-1 min-w-0">
        <div className="flex items-center gap-2 mb-1">
          <Avatar className="h-6 w-6">
            <AvatarFallback className="text-xs">{initials}</AvatarFallback>
          </Avatar>
          <span className="font-medium text-sm">{userName}</span>
          <span className="text-muted-foreground text-sm">
            {formatAction(event.action)}
          </span>
        </div>

        {/* Note content (per user decision: markdown support in notes) */}
        {displayContent && (
          <div className="mt-2 text-sm text-gray-700 whitespace-pre-wrap">
            {displayContent}
          </div>
        )}

        {/* Reassignment details */}
        {newAssignee && (
          <div className="mt-2 flex items-center gap-2 text-sm text-gray-600">
            <ArrowRight className="h-4 w-4" />
            <span>Assigned to new user</span>
            {reason && <span className="text-muted-foreground">- {reason}</span>}
          </div>
        )}
      </div>

      {/* Timestamp */}
      <div className="text-right text-xs text-muted-foreground whitespace-nowrap">
        <div title={format(new Date(event.timestamp), 'PPpp')}>
          {formatDistanceToNow(new Date(event.timestamp), { addSuffix: true })}
        </div>
      </div>
    </div>
  );
}
```

Create frontend/src/components/IncidentTimeline.tsx (with virtualization per RESEARCH.md):
```typescript
import { useRef } from 'react';
import { useVirtualizer } from '@tanstack/react-virtual';
import type { TimelineEvent } from '@/types/incident';
import { TimelineEventCard } from './TimelineEvent';
import { Skeleton } from '@/components/ui/skeleton';
import { Clock } from 'lucide-react';

interface IncidentTimelineProps {
  events: TimelineEvent[];
  isLoading?: boolean;
}

export function IncidentTimeline({ events, isLoading }: IncidentTimelineProps) {
  const parentRef = useRef<HTMLDivElement>(null);

  const virtualizer = useVirtualizer({
    count: events.length,
    getScrollElement: () => parentRef.current,
    estimateSize: () => 100, // Estimated row height
    overscan: 5, // Render 5 extra items above/below viewport
  });

  if (isLoading) {
    return (
      <div className="space-y-3">
        {[...Array(3)].map((_, i) => (
          <Skeleton key={i} className="h-24 w-full" />
        ))}
      </div>
    );
  }

  if (events.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center py-8 text-center">
        <Clock className="h-8 w-8 text-muted-foreground mb-2" />
        <p className="text-muted-foreground">No timeline events yet</p>
      </div>
    );
  }

  // For short lists (< 20), don't virtualize
  if (events.length < 20) {
    return (
      <div className="space-y-3">
        {events.map((event) => (
          <TimelineEventCard key={event.id} event={event} />
        ))}
      </div>
    );
  }

  // Virtualized list for 50+ events (per user decision)
  return (
    <div
      ref={parentRef}
      className="h-[500px] overflow-auto"
    >
      <div
        style={{
          height: `${virtualizer.getTotalSize()}px`,
          width: '100%',
          position: 'relative',
        }}
      >
        {virtualizer.getVirtualItems().map((virtualRow) => {
          const event = events[virtualRow.index];

          return (
            <div
              key={virtualRow.key}
              style={{
                position: 'absolute',
                top: 0,
                left: 0,
                width: '100%',
                transform: `translateY(${virtualRow.start}px)`,
              }}
            >
              <div className="pb-3">
                <TimelineEventCard event={event} />
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
}
```
  </action>
  <verify>
ls frontend/src/components/TimelineEvent.tsx
ls frontend/src/components/IncidentTimeline.tsx
cd frontend && npm run build
  </verify>
  <done>
Timeline component with virtualization for long lists. Events categorized with icons and colors. User notes have distinct blue background per user decision.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create TechnicalDetails, IncidentDetail, and Update Detail Page</name>
  <files>
    frontend/src/components/TechnicalDetails.tsx
    frontend/src/components/ExternalLinks.tsx
    frontend/src/components/IncidentDetail.tsx
    frontend/src/pages/IncidentDetailPage.tsx
  </files>
  <action>
Create frontend/src/components/TechnicalDetails.tsx (collapsible raw payload per user decision):
```typescript
import { useState } from 'react';
import {
  Collapsible,
  CollapsibleContent,
  CollapsibleTrigger,
} from '@/components/ui/collapsible';
import { Button } from '@/components/ui/button';
import { ChevronDown, Copy, Check } from 'lucide-react';
import { cn } from '@/lib/utils';

interface TechnicalDetailsProps {
  metadata: Record<string, unknown>;
  alerts?: Array<{
    id: string;
    title: string;
    severity: string;
    triggeredAt: string;
    externalId?: string;
  }>;
}

export function TechnicalDetails({ metadata, alerts }: TechnicalDetailsProps) {
  const [isOpen, setIsOpen] = useState(false);
  const [copied, setCopied] = useState(false);

  const jsonContent = JSON.stringify({ metadata, alerts }, null, 2);

  const handleCopy = async () => {
    await navigator.clipboard.writeText(jsonContent);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  return (
    <Collapsible open={isOpen} onOpenChange={setIsOpen}>
      <CollapsibleTrigger asChild>
        <Button variant="ghost" className="w-full justify-between">
          <span className="text-sm font-medium">Technical Details</span>
          <ChevronDown
            className={cn(
              'h-4 w-4 transition-transform',
              isOpen && 'rotate-180'
            )}
          />
        </Button>
      </CollapsibleTrigger>
      <CollapsibleContent>
        <div className="mt-2 p-4 bg-muted rounded-lg">
          <div className="flex justify-end mb-2">
            <Button
              variant="ghost"
              size="sm"
              onClick={handleCopy}
              className="h-8"
            >
              {copied ? (
                <>
                  <Check className="h-4 w-4 mr-1" />
                  Copied
                </>
              ) : (
                <>
                  <Copy className="h-4 w-4 mr-1" />
                  Copy JSON
                </>
              )}
            </Button>
          </div>
          <pre className="text-xs overflow-x-auto whitespace-pre-wrap font-mono">
            {jsonContent}
          </pre>
        </div>
      </CollapsibleContent>
    </Collapsible>
  );
}
```

Create frontend/src/components/ExternalLinks.tsx (quick-links per user decision):
```typescript
import { Button } from '@/components/ui/button';
import { ExternalLink } from 'lucide-react';

interface ExternalLinksProps {
  service?: string;
  metadata: Record<string, unknown>;
}

// Map services to external tool URLs
// In production, this would come from configuration
function getExternalLinks(service: string | undefined, metadata: Record<string, unknown>) {
  const links: Array<{ name: string; url: string }> = [];

  // DataDog dashboard
  if (metadata.datadog_dashboard_url || service) {
    const ddUrl = metadata.datadog_dashboard_url as string ||
      `https://app.datadoghq.com/apm/services/${service}`;
    links.push({ name: 'DataDog', url: ddUrl });
  }

  // Grafana
  if (metadata.grafana_url || service) {
    const grafanaUrl = metadata.grafana_url as string ||
      `https://grafana.example.com/d/service-dashboard?var-service=${service}`;
    links.push({ name: 'Grafana', url: grafanaUrl });
  }

  // Runbook
  if (metadata.runbook_url) {
    links.push({ name: 'Runbook', url: metadata.runbook_url as string });
  }

  // AWS CloudWatch
  if (metadata.cloudwatch_url) {
    links.push({ name: 'CloudWatch', url: metadata.cloudwatch_url as string });
  }

  return links;
}

export function ExternalLinks({ service, metadata }: ExternalLinksProps) {
  const links = getExternalLinks(service, metadata);

  if (links.length === 0) return null;

  return (
    <div className="flex flex-wrap gap-2">
      {links.map((link) => (
        <Button
          key={link.name}
          variant="outline"
          size="sm"
          asChild
        >
          <a href={link.url} target="_blank" rel="noopener noreferrer">
            <ExternalLink className="h-4 w-4 mr-1" />
            {link.name}
          </a>
        </Button>
      ))}
    </div>
  );
}
```

Create frontend/src/components/IncidentDetail.tsx (inline expandable detail per user decision):
```typescript
import type { Incident } from '@/types/incident';
import { useTimeline } from '@/hooks/useTimeline';
import { IncidentTimeline } from './IncidentTimeline';
import { TechnicalDetails } from './TechnicalDetails';
import { ExternalLinks } from './ExternalLinks';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Separator } from '@/components/ui/separator';
import { format } from 'date-fns';

interface IncidentDetailProps {
  incident: Incident;
  isInline?: boolean; // For expanded row vs full page
}

export function IncidentDetail({ incident, isInline = false }: IncidentDetailProps) {
  const { data: timeline, isLoading: timelineLoading } = useTimeline(incident.id);
  const service = incident.metadata?.service as string || incident.team.name;

  return (
    <div className={isInline ? 'p-4 bg-muted/50' : ''}>
      {/* Quick links section (per user decision) */}
      <div className="mb-4">
        <ExternalLinks service={service} metadata={incident.metadata} />
      </div>

      {/* Incident info */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 text-sm">
        <div>
          <span className="text-muted-foreground">Created</span>
          <p className="font-medium">
            {format(new Date(incident.createdAt), 'PPp')}
          </p>
        </div>
        {incident.acknowledgedAt && (
          <div>
            <span className="text-muted-foreground">Acknowledged</span>
            <p className="font-medium">
              {format(new Date(incident.acknowledgedAt), 'PPp')}
            </p>
          </div>
        )}
        {incident.resolvedAt && (
          <div>
            <span className="text-muted-foreground">Resolved</span>
            <p className="font-medium">
              {format(new Date(incident.resolvedAt), 'PPp')}
            </p>
          </div>
        )}
        <div>
          <span className="text-muted-foreground">Team</span>
          <p className="font-medium">{incident.team.name}</p>
        </div>
      </div>

      {/* Description */}
      {incident.description && (
        <div className="mb-4">
          <h4 className="text-sm font-medium text-muted-foreground mb-1">
            Description
          </h4>
          <p className="text-sm">{incident.description}</p>
        </div>
      )}

      <Separator className="my-4" />

      {/* Timeline (per user decision: embedded inline) */}
      <div className="mb-4">
        <h4 className="text-sm font-medium mb-3">Timeline</h4>
        <IncidentTimeline
          events={timeline || []}
          isLoading={timelineLoading}
        />
      </div>

      <Separator className="my-4" />

      {/* Technical details (per user decision: collapsible) */}
      <TechnicalDetails
        metadata={incident.metadata}
        alerts={incident.alerts}
      />
    </div>
  );
}
```

Update frontend/src/pages/IncidentDetailPage.tsx:
```typescript
import { useParams, Link } from 'react-router-dom';
import { useIncidentById } from '@/hooks/useIncidents';
import { IncidentDetail } from '@/components/IncidentDetail';
import { PriorityBadge } from '@/components/ui/priority-badge';
import { Button } from '@/components/ui/button';
import { Skeleton } from '@/components/ui/skeleton';
import { ArrowLeft, AlertCircle } from 'lucide-react';

export default function IncidentDetailPage() {
  const { id } = useParams<{ id: string }>();
  const { data: incident, isLoading, error } = useIncidentById(id);

  if (isLoading) {
    return (
      <div className="container mx-auto py-6 px-4 max-w-4xl">
        <Skeleton className="h-8 w-48 mb-4" />
        <Skeleton className="h-64 w-full" />
      </div>
    );
  }

  if (error || !incident) {
    return (
      <div className="container mx-auto py-6 px-4 max-w-4xl">
        <div className="flex flex-col items-center justify-center py-12 text-center">
          <AlertCircle className="h-12 w-12 text-red-500 mb-4" />
          <h3 className="text-lg font-medium">Incident not found</h3>
          <p className="text-muted-foreground mb-4">
            {error?.message || 'The incident could not be loaded'}
          </p>
          <Button asChild>
            <Link to="/incidents">
              <ArrowLeft className="h-4 w-4 mr-2" />
              Back to Incidents
            </Link>
          </Button>
        </div>
      </div>
    );
  }

  return (
    <div className="container mx-auto py-6 px-4 max-w-4xl">
      {/* Header */}
      <div className="mb-6">
        <Link
          to="/incidents"
          className="text-sm text-muted-foreground hover:text-foreground mb-2 inline-flex items-center"
        >
          <ArrowLeft className="h-4 w-4 mr-1" />
          Back to Incidents
        </Link>

        <div className="flex items-center gap-3 mt-2">
          <PriorityBadge priority={incident.priority} />
          <h1 className="text-xl font-bold">
            {incident.title || incident.fingerprint}
          </h1>
          <span className="text-muted-foreground">
            #{incident.id.slice(-6)}
          </span>
        </div>

        <div className="flex items-center gap-2 mt-2">
          <span
            className={`text-xs font-medium px-2 py-1 rounded ${
              incident.status === 'OPEN'
                ? 'bg-red-100 text-red-700'
                : incident.status === 'ACKNOWLEDGED'
                ? 'bg-yellow-100 text-yellow-700'
                : incident.status === 'RESOLVED'
                ? 'bg-green-100 text-green-700'
                : 'bg-gray-100 text-gray-700'
            }`}
          >
            {incident.status}
          </span>
          <span className="text-sm text-muted-foreground">
            {incident.assignedUser
              ? `Assigned to ${incident.assignedUser.firstName} ${incident.assignedUser.lastName}`
              : 'Unassigned'}
          </span>
        </div>
      </div>

      {/* Detail content */}
      <IncidentDetail incident={incident} />
    </div>
  );
}
```

Finally, update IncidentRow to show detail when expanded:
```typescript
// In frontend/src/components/IncidentRow.tsx, update to include expandable content:

import { IncidentDetail } from './IncidentDetail';

// Inside the Card component, after the collapsed content div, add:
{isExpanded && (
  <div className="border-t">
    <IncidentDetail incident={incident} isInline />
  </div>
)}
```
  </action>
  <verify>
ls frontend/src/components/TechnicalDetails.tsx
ls frontend/src/components/ExternalLinks.tsx
ls frontend/src/components/IncidentDetail.tsx
ls frontend/src/pages/IncidentDetailPage.tsx
cd frontend && npm run build
  </verify>
  <done>
Incident detail shows full timeline (virtualized for 50+ events), external tool links, and collapsible technical details. Detail works both inline (expanded row) and as standalone page. Notes have distinct visual style.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npm run build` - Compiles without errors
2. Navigate to /incidents and expand a row - timeline appears inline
3. Navigate to /incidents/:id - full detail page with timeline
4. Verify timeline events sorted newest first
5. Verify user notes have blue background
6. Verify Technical Details section is collapsible
7. Verify external links appear when service metadata exists
8. Test with 50+ timeline events - virtualization should keep UI smooth
</verification>

<success_criteria>
- [ ] Timeline shows events in chronological order (newest first)
- [ ] User notes visually distinct (blue background)
- [ ] Virtualized scrolling for timelines with 50+ events
- [ ] Technical Details collapsible section with raw JSON
- [ ] External tool links (DataDog, Grafana, Runbook) when metadata present
- [ ] Detail works inline in expanded row and as standalone page
- [ ] Loading skeletons while fetching timeline
- [ ] Empty state when no timeline events
</success_criteria>

<output>
After completion, create `.planning/phases/06-incident-management-dashboard**---web-and-mobile-ui-for-incident-response/06-04-SUMMARY.md`
</output>
