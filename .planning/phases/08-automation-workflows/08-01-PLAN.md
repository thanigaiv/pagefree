---
phase: 08-automation-workflows
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/types/workflow.ts
autonomous: true

must_haves:
  truths:
    - "Workflow model exists with definition JSON, version, scope, enabled state"
    - "WorkflowVersion tracks every edit with snapshot and rollback capability"
    - "WorkflowExecution tracks running/completed workflows per incident"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Workflow, WorkflowVersion, WorkflowExecution, WorkflowActionSecret models"
      contains: "model Workflow"
    - path: "src/types/workflow.ts"
      provides: "TypeScript types for workflow definitions"
      exports: ["WorkflowDefinition", "WorkflowNode", "ActionData", "TriggerCondition"]
  key_links:
    - from: "src/types/workflow.ts"
      to: "prisma/schema.prisma"
      via: "Types match database JSON structure"
      pattern: "WorkflowDefinition"
---

<objective>
Create database schema and TypeScript types for workflow automation system.

Purpose: Foundation for visual workflow builder - stores workflow definitions as JSON with version history, execution tracking, and action secrets.

Output: Prisma schema additions (Workflow, WorkflowVersion, WorkflowExecution, WorkflowActionSecret models) and comprehensive TypeScript types.
</objective>

<execution_context>
@/Users/tvellore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tvellore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-automation-workflows/08-CONTEXT.md
@.planning/phases/08-automation-workflows/08-RESEARCH.md

# Existing schema and patterns
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add workflow models to Prisma schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add the following models to prisma/schema.prisma after the existing models:

1. **Workflow model** with:
   - id (cuid), name, description (required per user decision)
   - version Int @default(1)
   - definition Json (stores WorkflowDefinition structure)
   - scopeType String ('team' or 'global' per user decision)
   - teamId String? with relation to Team
   - isEnabled Boolean @default(false) (toggle per user decision)
   - isTemplate Boolean @default(false)
   - templateCategory String? ('Ticketing', 'Communication', 'Auto-resolution' per user decision)
   - createdById String with relation to User
   - timestamps (createdAt, updatedAt with @db.Timestamptz)
   - Relations: versions (WorkflowVersion[]), executions (WorkflowExecution[])
   - Indexes: [teamId, isEnabled], [isTemplate, templateCategory], [scopeType]

2. **WorkflowVersion model** (full version history per user decision):
   - id (cuid), workflowId, version Int
   - definition Json (snapshot at this version)
   - changedById String with relation to User
   - changeNote String?
   - createdAt timestamp
   - Unique constraint: [workflowId, version]
   - Cascade delete when workflow deleted

3. **WorkflowExecution model** (tracks each execution):
   - id (cuid), workflowId, workflowVersion Int
   - definitionSnapshot Json (frozen definition per user decision - in-flight uses old version)
   - incidentId String with relation to Incident
   - triggeredBy String ('event' | 'manual')
   - triggerEvent String? ('incident_created', 'state_changed', 'escalation', 'age')
   - status String ('PENDING', 'RUNNING', 'COMPLETED', 'FAILED', 'CANCELLED')
   - currentNodeId String?
   - completedNodes Json @default("[]")
   - error String?
   - startedAt, completedAt, failedAt (nullable timestamps)
   - Indexes: [workflowId, status], [incidentId], [status, createdAt]

4. **WorkflowActionSecret model** (encrypted secrets for actions):
   - id (cuid), workflowId String
   - name String (e.g., 'jira_api_token', 'linear_api_key')
   - valueHash String (encrypted)
   - createdAt timestamp
   - Unique constraint: [workflowId, name]

Add relation from Incident model to WorkflowExecution[]:
- workflowExecutions WorkflowExecution[]

Add relation from Team model to Workflow[]:
- workflows Workflow[]

Add User relations for workflow ownership:
- workflowsCreated Workflow[] @relation("WorkflowCreatedBy")
- workflowVersionsCreated WorkflowVersion[]
  </action>
  <verify>npx prisma validate && npx prisma format</verify>
  <done>Prisma schema validates with all 4 workflow models and proper relations</done>
</task>

<task type="auto">
  <name>Task 2: Create TypeScript types for workflow definitions</name>
  <files>src/types/workflow.ts</files>
  <action>
Create comprehensive TypeScript types matching the JSON structure stored in workflow.definition:

1. **WorkflowDefinition** (top-level structure):
   - id, name, description (required per user decision)
   - version: number
   - nodes: WorkflowNode[]
   - edges: WorkflowEdge[]
   - trigger: TriggerConfig
   - settings: WorkflowSettings

2. **WorkflowNode** (React Flow compatible):
   - id: string
   - type: 'trigger' | 'action' | 'condition' | 'delay'
   - position: { x: number; y: number }
   - data: TriggerData | ActionData | ConditionData | DelayData

3. **WorkflowEdge** (React Flow compatible):
   - id: string
   - source: string
   - target: string
   - sourceHandle?: string (for branching - 'true' | 'false')

4. **TriggerConfig**:
   - type: TriggerType ('incident_created' | 'state_changed' | 'escalation' | 'manual' | 'age')
   - conditions: TriggerCondition[] (simple field matching per user decision)
   - ageThresholdMinutes?: number (for 'age' trigger type)
   - stateTransition?: { from?: string; to: string } (for 'state_changed')

5. **TriggerCondition** (simple matching per user decision - NO AND/OR):
   - field: string ('priority', 'service', 'metadata.service', 'team')
   - value: string

6. **ActionData** union type:
   - actionType: 'webhook' | 'jira' | 'linear'
   - name: string (display name)
   - config: WebhookConfig | JiraConfig | LinearConfig
   - retry: RetryConfig

7. **WebhookConfig**:
   - url: string (template allowed)
   - method: 'POST' | 'PUT' | 'PATCH'
   - headers: Record<string, string> (template allowed)
   - body: string (JSON template)
   - auth: WebhookAuth

8. **WebhookAuth**:
   - type: 'none' | 'bearer' | 'basic' | 'oauth2' | 'custom' (per user decision)
   - token?: string (for bearer)
   - username?: string, password?: string (for basic)
   - clientId?: string, clientSecret?: string, tokenUrl?: string (for oauth2)
   - customHeaders?: Record<string, string> (for custom)

9. **JiraConfig**:
   - projectKey: string
   - issueType: string
   - summary: string (template)
   - description: string (template)
   - priority?: string
   - labels?: string[]

10. **LinearConfig**:
    - teamId: string (Linear team)
    - title: string (template)
    - description: string (template)
    - priority?: number (0-4)
    - labelIds?: string[]

11. **ConditionData** (branching per user decision):
    - field: string
    - operator: '=' (simple equality per user decision - no advanced operators)
    - value: string
    - name: string (display name like "Check Priority")

12. **DelayData** (configurable delays per user decision):
    - durationMinutes: number
    - name: string (e.g., "Wait 5 minutes")

13. **RetryConfig**:
    - attempts: number
    - backoff: 'exponential'
    - initialDelayMs: number

14. **WorkflowSettings**:
    - timeout: '1min' | '5min' | '15min' (per user decision)
    - enabled: boolean

15. **TemplateContext** (for Handlebars interpolation):
    - incident: { id, title, priority, status, createdAt, acknowledgedAt?, teamName, metadata }
    - assignee?: { id, email, firstName, lastName, phone? }
    - team: { id, name, slackChannel? }
    - workflow: { id, name, executionId }

16. **WorkflowExecutionResult**:
    - executionId: string
    - status: 'COMPLETED' | 'FAILED' | 'CANCELLED'
    - completedNodes: NodeResult[]
    - error?: string
    - duration: number

17. **NodeResult**:
    - nodeId: string
    - status: 'completed' | 'failed' | 'skipped'
    - result?: any (webhook response, ticket URL, etc.)
    - error?: string
    - startedAt: Date
    - completedAt: Date

Export all types. Use proper TypeScript union types and discriminated unions where appropriate.
  </action>
  <verify>npx tsc --noEmit src/types/workflow.ts</verify>
  <done>TypeScript types compile without errors, exports all workflow-related interfaces</done>
</task>

<task type="auto">
  <name>Task 3: Run Prisma migration and generate client</name>
  <files>prisma/migrations/*</files>
  <action>
Run Prisma migration to create the workflow tables:

1. Generate migration:
   npx prisma migrate dev --name add_workflow_models

2. Generate updated Prisma client:
   npx prisma generate

3. Verify the migration created:
   - workflow table
   - workflow_version table
   - workflow_execution table
   - workflow_action_secret table
   - Proper indexes and foreign keys

If using test database, ensure it's applied there too.
  </action>
  <verify>npx prisma db push --force-reset (in test) && npx prisma generate</verify>
  <done>Migration applied, Prisma client regenerated with Workflow types available</done>
</task>

</tasks>

<verification>
1. `npx prisma validate` passes
2. `npx tsc --noEmit` compiles all type files
3. Prisma client includes Workflow, WorkflowVersion, WorkflowExecution, WorkflowActionSecret
4. Can import types from src/types/workflow.ts
</verification>

<success_criteria>
- Database schema includes all 4 workflow models with correct relations
- TypeScript types cover all user decisions (triggers, actions, conditions, delays, auth)
- Version history model supports rollback capability
- Execution model tracks definitionSnapshot for in-flight version isolation
- Prisma client generates successfully
</success_criteria>

<output>
After completion, create `.planning/phases/08-automation-workflows/08-01-SUMMARY.md`
</output>
