---
phase: 08-automation-workflows
plan: 08
type: execute
wave: 4
depends_on: ["08-03", "08-04"]
files_modified:
  - src/tests/workflow.test.ts
  - src/services/workflow/workflow-integration.ts
  - src/app.ts
autonomous: true

must_haves:
  truths:
    - "Workflow triggers on incident events"
    - "Workflow executes actions sequentially"
    - "Workflow failures notify appropriate users"
    - "All workflow actions logged to incident timeline"
  artifacts:
    - path: "src/tests/workflow.test.ts"
      provides: "Integration tests for workflow system"
      min_lines: 200
    - path: "src/services/workflow/workflow-integration.ts"
      provides: "Integration with incident lifecycle"
      exports: ["triggerWorkflows", "setupWorkflowTriggers"]
  key_links:
    - from: "src/services/workflow/workflow-integration.ts"
      to: "src/services/incident.service.ts"
      via: "Hooks into incident events"
      pattern: "incident\\."
    - from: "src/app.ts"
      to: "src/workers/workflow.worker.ts"
      via: "Worker startup"
      pattern: "startWorkflowWorker"
---

<objective>
Integrate workflow system with incident lifecycle, create tests, and wire up worker startup.

Purpose: Complete the workflow automation system by connecting it to incident events and verifying everything works together.

Output: Incident integration hooks, comprehensive tests, worker startup in app.ts.
</objective>

<execution_context>
@/Users/tvellore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tvellore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-automation-workflows/08-CONTEXT.md
@.planning/phases/08-automation-workflows/08-RESEARCH.md
@.planning/phases/08-automation-workflows/08-03-SUMMARY.md

# Existing integration patterns
@src/services/incident.service.ts
@src/services/escalation.service.ts
@src/tests/incident.test.ts
@src/app.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create workflow integration with incident lifecycle</name>
  <files>src/services/workflow/workflow-integration.ts</files>
  <action>
Create src/services/workflow/workflow-integration.ts:

1. Import workflow trigger and queue services:
   ```typescript
   import { findMatchingWorkflows } from './workflow-trigger.service.js';
   import { scheduleWorkflow } from '../../queues/workflow.queue.js';
   ```

2. Export triggerWorkflows function:
   ```typescript
   export async function triggerWorkflows(event: TriggerEvent): Promise<void>
   ```
   - Call findMatchingWorkflows(event)
   - For each matching workflow:
     a. Create WorkflowExecution record with PENDING status
     b. Snapshot definition to definitionSnapshot (per user decision - in-flight uses old version)
     c. Schedule workflow job via scheduleWorkflow
     d. Audit log: workflow.triggered
   - Log count of triggered workflows

3. Create hook functions to call from incident service:

**onIncidentCreated(incident):**
- Build TriggerEvent with type='incident_created'
- Call triggerWorkflows

**onIncidentStateChanged(incident, previousState, newState):**
- Build TriggerEvent with type='state_changed', previousState, newState
- Call triggerWorkflows

**onIncidentEscalated(incident):**
- Build TriggerEvent with type='escalation'
- Call triggerWorkflows

**triggerManualWorkflow(workflowId, incidentId, userId):**
- Load workflow by ID
- Create execution with triggeredBy='manual'
- Schedule job
- Return executionId

4. Setup age-based trigger polling (per user decision - incident age triggers):
   ```typescript
   export async function checkAgeBasedTriggers(): Promise<void>
   ```
   - Find all enabled workflows with trigger.type='age'
   - Query OPEN incidents older than their threshold without recent execution
   - Trigger matching workflows
   - Run on interval (every 5 minutes)

5. Export setupWorkflowTriggers to initialize age polling:
   ```typescript
   export function setupWorkflowTriggers(): void {
     setInterval(checkAgeBasedTriggers, 5 * 60 * 1000);
     logger.info('Workflow age triggers initialized');
   }
   ```

6. Handle errors gracefully - log but don't throw (workflows shouldn't break incident flow)
  </action>
  <verify>npx tsc --noEmit src/services/workflow/workflow-integration.ts</verify>
  <done>Workflow integration hooks into incident create/state change/escalation events</done>
</task>

<task type="auto">
  <name>Task 2: Wire up incident service and app.ts</name>
  <files>src/services/incident.service.ts, src/app.ts</files>
  <action>
Update src/services/incident.service.ts:

1. Import workflow integration:
   ```typescript
   import { onIncidentCreated, onIncidentStateChanged, onIncidentEscalated } from './workflow/workflow-integration.js';
   ```

2. In createIncident function (or wherever incidents are created from alerts):
   - After successful incident creation
   - Call onIncidentCreated(incident) in try/catch (don't fail incident creation)

3. In acknowledgeIncident function:
   - After successful acknowledgment
   - Call onIncidentStateChanged(incident, 'OPEN', 'ACKNOWLEDGED')

4. In resolveIncident function:
   - After successful resolution
   - Call onIncidentStateChanged(incident, previousStatus, 'RESOLVED')

5. In closeIncident function:
   - After successful close
   - Call onIncidentStateChanged(incident, 'RESOLVED', 'CLOSED')

6. In escalation handling:
   - After escalation to next level
   - Call onIncidentEscalated(incident)

All calls should be wrapped in try/catch to prevent workflow failures from breaking incident operations.

---

Update src/app.ts:

1. Import workflow worker and integration:
   ```typescript
   import { startWorkflowWorker } from './workers/workflow.worker.js';
   import { setupWorkflowTriggers } from './services/workflow/workflow-integration.js';
   ```

2. In server startup (after Redis connection established):
   ```typescript
   // Start workflow worker
   try {
     await startWorkflowWorker();
     setupWorkflowTriggers();
     logger.info('Workflow system initialized');
   } catch (error) {
     logger.error({ error }, 'Failed to start workflow worker - running in degraded mode');
     // Don't crash server - workflows are non-critical
   }
   ```

3. Add workflow routes:
   ```typescript
   import { workflowRoutes } from './routes/workflow.routes.js';
   import { workflowTemplateRoutes } from './routes/workflow-template.routes.js';

   app.use('/api/workflows', workflowRoutes);
   app.use('/api/workflow-templates', workflowTemplateRoutes);
   ```

4. Handle graceful shutdown for workflow worker (similar to escalation worker)
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>Incident service triggers workflows, app.ts starts worker and mounts routes</done>
</task>

<task type="auto">
  <name>Task 3: Create comprehensive integration tests</name>
  <files>src/tests/workflow.test.ts</files>
  <action>
Create src/tests/workflow.test.ts following existing test patterns:

1. Test setup:
   - Create test user with team admin role
   - Create test team
   - Create test incidents
   - Mock external services (webhook endpoints, Jira, Linear)

2. **Workflow CRUD tests:**
   - Create workflow with required name/description
   - Fail creation without name (per user decision)
   - Update creates new version (per user decision - version history)
   - Get returns workflow with versions
   - Delete succeeds when no active executions
   - Delete fails with active executions (409)
   - Duplicate creates copy with v1 (per user decision)
   - Toggle enabled/disabled works (per user decision)
   - Export produces valid JSON (per user decision)
   - Import creates workflow from JSON (per user decision)

3. **Permission tests:**
   - Team admin can create team workflow (per user decision)
   - Non-admin cannot create workflow
   - Platform admin can create global workflow
   - Team member can view team workflow
   - Anyone can view global workflow

4. **Trigger matching tests:**
   - Workflow triggers on incident_created when conditions match
   - Workflow doesn't trigger when conditions don't match
   - state_changed trigger fires on acknowledgment
   - state_changed trigger fires on resolution
   - Multiple workflows can trigger from one incident (per Claude's discretion)
   - Cycle detection prevents infinite loops

5. **Execution tests:**
   - Sequential execution runs actions in order
   - Stop on first error behavior (per user decision)
   - Timeout cancels long-running workflow (per user decision)
   - Condition node routes to correct branch
   - Delay node waits specified duration
   - Retry with exponential backoff on transient failure (per user decision)

6. **Template interpolation tests:**
   - {{incident.title}} interpolates correctly
   - {{assignee.email}} interpolates correctly
   - {{uppercase incident.priority}} helper works
   - Invalid template throws error

7. **Timeline integration tests:**
   - workflow.execution.started audit event created
   - workflow.action.completed audit event created
   - workflow.execution.completed audit event created
   - workflow.execution.failed audit event created on error

8. **Template library tests:**
   - List templates by category (per user decision)
   - Create workflow from template (per user decision)
   - Search templates by name

9. **Analytics tests:**
   - Execution count calculated correctly (per user decision)
   - Success rate calculated correctly (per user decision)
   - Failure points identified (per user decision)

Use vi.mock for external services. Test both success and failure paths.
  </action>
  <verify>npm test -- workflow.test.ts</verify>
  <done>Comprehensive tests cover workflow CRUD, triggers, execution, and integration</done>
</task>

</tasks>

<verification>
1. `npm test` passes all workflow tests
2. Creating incident triggers matching workflows
3. Acknowledging/resolving incident triggers state_changed workflows
4. Manual trigger button works
5. Workflow executions appear in incident timeline
6. Failed workflows send notifications
7. Age-based triggers fire for old incidents
</verification>

<success_criteria>
- All 7 AUTO requirements covered:
  - AUTO-01: User can define automated actions triggered by incident conditions
  - AUTO-02: System supports basic actions (create ticket, post to Slack [via webhook], call webhook)
  - AUTO-03: User can define workflows with conditional logic
  - AUTO-04: User can create workflows using visual workflow builder
  - AUTO-05: System provides template library for common workflows
  - AUTO-06: User can trigger runbook automation [DEFERRED - marked in tests]
  - AUTO-07: System logs all automated actions to incident timeline
- Workflow integration doesn't break incident operations on failure
- Tests verify all user decisions are implemented
</success_criteria>

<output>
After completion, create `.planning/phases/08-automation-workflows/08-08-SUMMARY.md`
</output>
