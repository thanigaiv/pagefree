---
phase: 08-automation-workflows
plan: 04
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/services/workflow/workflow.service.ts
  - src/routes/workflow.routes.ts
  - src/routes/workflow-template.routes.ts
autonomous: true

must_haves:
  truths:
    - "User can CRUD workflows with version history"
    - "User can duplicate workflows"
    - "User can export/import workflows as JSON"
    - "Template library provides categorized pre-built workflows"
  artifacts:
    - path: "src/services/workflow/workflow.service.ts"
      provides: "Workflow CRUD with versioning"
      exports: ["workflowService"]
    - path: "src/routes/workflow.routes.ts"
      provides: "REST API endpoints"
      exports: ["workflowRoutes"]
    - path: "src/routes/workflow-template.routes.ts"
      provides: "Template library endpoints"
      exports: ["workflowTemplateRoutes"]
  key_links:
    - from: "src/routes/workflow.routes.ts"
      to: "src/services/workflow/workflow.service.ts"
      via: "Service calls"
      pattern: "workflowService\\."
    - from: "src/services/workflow/workflow.service.ts"
      to: "prisma.workflowVersion.create"
      via: "Version snapshot on every edit"
      pattern: "workflowVersion\\.create"
---

<objective>
Create workflow CRUD service with version history, duplication, export/import, and template library API.

Purpose: Enable users to manage workflows through REST API with full version control and template library.

Output: Workflow service with versioning, workflow routes, template library routes.
</objective>

<execution_context>
@/Users/tvellore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tvellore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-automation-workflows/08-CONTEXT.md
@.planning/phases/08-automation-workflows/08-RESEARCH.md

# Existing route patterns
@src/routes/incident.routes.ts
@src/routes/team.routes.ts
@src/services/team.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create workflow CRUD service with versioning</name>
  <files>src/services/workflow/workflow.service.ts</files>
  <action>
Create src/services/workflow/workflow.service.ts:

1. Import types and prisma

2. Create validation (per user decision - name and description required):
   ```typescript
   const workflowSchema = z.object({
     name: z.string().min(1).max(100),
     description: z.string().min(1).max(500),
     definition: z.any(),  // Validated separately
     scopeType: z.enum(['team', 'global']),
     teamId: z.string().optional(),
     isEnabled: z.boolean().optional()
   });
   ```

3. Export workflowService object with methods:

**create(data, userId):**
- Validate name/description required
- If scopeType='team': require teamId, verify user is team admin (per user decision)
- If scopeType='global': verify user is platform admin
- Create workflow with version=1
- Create initial WorkflowVersion snapshot
- Audit log: workflow.created
- Return workflow

**update(id, data, userId, changeNote?):**
- Load workflow
- Check permissions (team admin or platform admin for global)
- Increment version
- Create WorkflowVersion snapshot with changedById, changeNote (per user decision - full version history)
- Update workflow
- Audit log: workflow.updated
- Return updated workflow

**delete(id, userId):**
- Check no active (RUNNING) executions
- Check permissions
- Hard delete workflow (cascade deletes versions)
- Audit log: workflow.deleted

**get(id, userId):**
- Load workflow with versions, recent executions
- Check view permissions (team member or any user for global)
- Return workflow

**list(filters, userId):**
- Filter by teamId, scopeType, isEnabled, isTemplate
- Apply pagination
- Return workflows with counts

**duplicate(id, userId):** (per user decision)
- Load workflow
- Create copy with:
  - name = "{original.name} (Copy)"
  - version = 1
  - isEnabled = false
- Create initial version snapshot
- Return new workflow

**toggle(id, enabled, userId):** (per user decision)
- Update isEnabled field
- Audit log: workflow.enabled or workflow.disabled

**getVersionHistory(id):** (per user decision - rollback capability)
- Return all WorkflowVersion records ordered by version desc

**rollback(id, toVersion, userId):** (per user decision)
- Load WorkflowVersion at toVersion
- Create new version with rolled-back definition
- Audit log: workflow.rolledBack

**exportJson(id):** (per user decision)
- Return workflow definition as JSON
- Include metadata (name, description, scopeType)
- Exclude secrets

**importJson(json, userId, teamId?):** (per user decision)
- Parse and validate JSON structure
- Create new workflow from imported definition
- Reset version to 1
- Return created workflow
  </action>
  <verify>npx tsc --noEmit src/services/workflow/workflow.service.ts</verify>
  <done>Workflow service supports CRUD, versioning, duplication, export/import</done>
</task>

<task type="auto">
  <name>Task 2: Create workflow REST API routes</name>
  <files>src/routes/workflow.routes.ts</files>
  <action>
Create src/routes/workflow.routes.ts following existing route patterns:

1. Create router with Express Router

2. Apply auth middleware to all routes (requireAuth)

3. Implement endpoints:

**POST /api/workflows** - Create workflow
- Body: { name, description, definition, scopeType, teamId? }
- Returns: 201 with created workflow
- Requires: team admin (for team) or platform admin (for global) per user decision

**GET /api/workflows** - List workflows
- Query: teamId?, scopeType?, isEnabled?, isTemplate?, page?, limit?
- Returns: paginated workflows with total count

**GET /api/workflows/:id** - Get workflow
- Returns: workflow with versions (limited), execution stats

**PUT /api/workflows/:id** - Update workflow
- Body: { name?, description?, definition?, changeNote? }
- Returns: updated workflow
- Creates new version snapshot

**DELETE /api/workflows/:id** - Delete workflow
- Returns: 204 on success
- Fails if active executions exist

**POST /api/workflows/:id/duplicate** - Duplicate workflow (per user decision)
- Returns: 201 with new workflow copy

**PATCH /api/workflows/:id/toggle** - Toggle enabled (per user decision)
- Body: { enabled: boolean }
- Returns: updated workflow

**GET /api/workflows/:id/versions** - Get version history (per user decision)
- Returns: array of WorkflowVersion records

**POST /api/workflows/:id/rollback** - Rollback to version (per user decision)
- Body: { toVersion: number }
- Returns: updated workflow

**GET /api/workflows/:id/export** - Export as JSON (per user decision)
- Returns: JSON workflow definition

**POST /api/workflows/import** - Import from JSON (per user decision)
- Body: { json: object, teamId?: string }
- Returns: 201 with created workflow

**POST /api/workflows/:id/execute** - Manual trigger (per user decision)
- Body: { incidentId: string }
- Returns: 202 with executionId

**GET /api/workflows/:id/analytics** - Execution analytics (per user decision)
- Query: days? (default 30)
- Returns: { executionCount, successRate, avgDuration, failurePoints }

4. Add Zod validation to request bodies

5. Handle errors with proper status codes (400, 403, 404, 409)

6. Export router
  </action>
  <verify>npx tsc --noEmit src/routes/workflow.routes.ts</verify>
  <done>All workflow CRUD endpoints implemented with proper auth checks</done>
</task>

<task type="auto">
  <name>Task 3: Create template library routes</name>
  <files>src/routes/workflow-template.routes.ts</files>
  <action>
Create src/routes/workflow-template.routes.ts:

1. Create router with Express Router

2. Apply auth middleware

3. Implement endpoints:

**GET /api/workflow-templates** - List templates (per user decision - template library)
- Query: category? (Ticketing, Communication, Auto-resolution), search?
- Returns: templates filtered by category with search
- Anyone can view templates

**GET /api/workflow-templates/:id** - Get template details
- Returns: template with full definition

**POST /api/workflow-templates/:id/use** - Create workflow from template (per user decision)
- Body: { name, description, teamId?, customizations? }
- Returns: 201 with new workflow based on template
- Requires: team admin for team-scoped

**POST /api/workflow-templates** - Create template (platform admin only)
- Body: { name, description, definition, category }
- Returns: 201 with created template

**PUT /api/workflow-templates/:id** - Update template (platform admin only)
- Body: { name?, description?, definition?, category? }
- Returns: updated template

**DELETE /api/workflow-templates/:id** - Delete template (platform admin only)
- Returns: 204 on success

4. Seed default templates in database (can be done in separate migration or startup script):
   - **Ticketing category:**
     - "Create Jira Ticket on Critical Incident"
     - "Create Linear Issue for High Priority"
   - **Communication category:**
     - "Post to Slack on State Change"
     - "Webhook Notification on Resolution"
   - **Auto-resolution category:**
     - "Auto-acknowledge Low Priority After 1 Hour"

5. Template organization by categories (per user decision):
   - templateCategory field stores category
   - Filter endpoint supports category filter
   - Search searches name and description

6. Export router
  </action>
  <verify>npx tsc --noEmit src/routes/workflow-template.routes.ts</verify>
  <done>Template library API supports categories, search, and creating workflows from templates</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` compiles all route files
2. Workflow CRUD endpoints work with proper auth
3. Version history records every edit
4. Duplicate creates copy with reset version
5. Export/import preserves workflow structure
6. Template library filterable by category
</verification>

<success_criteria>
- Team admin permissions required for team workflows per user decision
- Full version history with rollback capability per user decision
- Workflow duplication enabled per user decision
- JSON export/import per user decision
- Template library organized by categories per user decision
- Required name and description fields per user decision
- Detailed execution analytics per user decision
</success_criteria>

<output>
After completion, create `.planning/phases/08-automation-workflows/08-04-SUMMARY.md`
</output>
