---
phase: 02-alert-ingestion-webhooks
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - prisma/migrations/*
autonomous: true

must_haves:
  truths:
    - "Alert model exists with normalized fields (title, severity, status)"
    - "Integration model exists with per-integration webhook secrets"
    - "WebhookDelivery model tracks every webhook attempt with idempotency fields"
    - "All timestamps use UTC (@db.Timestamptz)"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Alert, Integration, WebhookDelivery models with enums"
      contains: "model Alert"
  key_links:
    - from: "WebhookDelivery"
      to: "Integration"
      via: "integrationId foreign key"
      pattern: "integrationId.*String"
    - from: "WebhookDelivery"
      to: "Alert"
      via: "alertId foreign key (nullable for failed/duplicate)"
      pattern: "alertId.*String\\?"
---

<objective>
Add database models for alert ingestion: Integration, Alert, and WebhookDelivery tables with proper enums and indexes.

Purpose: Establish data layer foundation for webhook processing - Integration stores per-integration config including webhook secrets, Alert stores normalized alert data, WebhookDelivery logs every webhook attempt for idempotency and audit.

Output: Extended Prisma schema with new models, applied migration.
</objective>

<execution_context>
@/Users/tvellore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tvellore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-alert-ingestion-webhooks/02-RESEARCH.md (Database Schema Requirements section)
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add alert ingestion enums and models to Prisma schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add the following to prisma/schema.prisma:

1. Add enums after existing enums:
```prisma
enum AlertSeverity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
  INFO
}

enum AlertStatus {
  OPEN
  ACKNOWLEDGED
  RESOLVED
  CLOSED
}
```

2. Add Integration model:
```prisma
model Integration {
  id                          String   @id @default(cuid())
  name                        String   @unique  // e.g., "datadog-production"
  type                        String   // datadog, newrelic, pagerduty, generic
  webhookSecret               String   // HMAC secret for signature verification
  isActive                    Boolean  @default(true)

  // Signature configuration
  signatureHeader             String   @default("X-Webhook-Signature")
  signatureAlgorithm          String   @default("sha256")
  signatureFormat             String   @default("hex") // hex, base64
  signaturePrefix             String?  // e.g., "sha256="

  // Idempotency configuration
  deduplicationWindowMinutes  Int      @default(15)

  // Relations
  alerts                      Alert[]
  webhookDeliveries           WebhookDelivery[]

  createdAt                   DateTime @default(now()) @db.Timestamptz
  updatedAt                   DateTime @updatedAt @db.Timestamptz

  @@index([type])
  @@index([isActive])
}
```

3. Add Alert model:
```prisma
model Alert {
  id                String        @id @default(cuid())

  // Normalized fields (extracted from payload)
  title             String
  description       String?
  severity          AlertSeverity
  status            AlertStatus   @default(OPEN)
  source            String        // Integration name
  externalId        String?       // ID from monitoring tool

  // Timestamps (all UTC per Phase 1 decision)
  triggeredAt       DateTime      @db.Timestamptz  // When alert fired (from payload)
  acknowledgedAt    DateTime?     @db.Timestamptz
  resolvedAt        DateTime?     @db.Timestamptz
  closedAt          DateTime?     @db.Timestamptz

  // Metadata (flexible JSON for integration-specific fields)
  metadata          Json          @default("{}")

  // Relations
  integrationId     String
  integration       Integration   @relation(fields: [integrationId], references: [id])
  deliveries        WebhookDelivery[]

  createdAt         DateTime      @default(now()) @db.Timestamptz
  updatedAt         DateTime      @updatedAt @db.Timestamptz

  @@index([integrationId, triggeredAt])
  @@index([status, triggeredAt])
  @@index([severity, triggeredAt])
  @@index([externalId])
}
```

4. Add WebhookDelivery model:
```prisma
model WebhookDelivery {
  id                  String    @id @default(cuid())

  // Idempotency tracking
  idempotencyKey      String?   // External key if provided (X-Request-ID, etc.)
  contentFingerprint  String    // SHA-256 hash of normalized payload

  // Raw data preservation
  rawPayload          Json      // Original webhook body
  headers             Json      // Sanitized headers (exclude secrets)

  // Processing result
  statusCode          Int       // HTTP status returned
  errorMessage        String?   // If processing failed
  processedAt         DateTime  @db.Timestamptz

  // Relations
  integrationId       String
  integration         Integration @relation(fields: [integrationId], references: [id])
  alertId             String?   // Null if duplicate or failed validation
  alert               Alert?    @relation(fields: [alertId], references: [id])

  createdAt           DateTime  @default(now()) @db.Timestamptz

  @@index([integrationId, idempotencyKey])
  @@index([integrationId, contentFingerprint, createdAt])
  @@index([integrationId, createdAt])
  @@index([alertId])
}
```

Note: Place new models after existing Session and ApiKey models, maintaining the comment section pattern used in the schema.
  </action>
  <verify>Run `npx prisma validate` to verify schema syntax is correct</verify>
  <done>Schema validates without errors, contains AlertSeverity enum, AlertStatus enum, Integration model, Alert model, and WebhookDelivery model</done>
</task>

<task type="auto">
  <name>Task 2: Apply database migration</name>
  <files>prisma/migrations/*</files>
  <action>
Run Prisma migration to create the new tables:

```bash
npx prisma migrate dev --name add_alert_ingestion_models
```

This creates:
- AlertSeverity and AlertStatus enums in PostgreSQL
- Integration table with webhook configuration fields
- Alert table with normalized alert data
- WebhookDelivery table for idempotency tracking and audit

Verify migration includes all indexes defined in schema.
  </action>
  <verify>Run `npx prisma migrate status` to confirm migration applied. Run `npx prisma db pull --print` and verify new tables exist.</verify>
  <done>Migration applied successfully, database contains Integration, Alert, and WebhookDelivery tables with all specified columns and indexes</done>
</task>

</tasks>

<verification>
- `npx prisma validate` succeeds
- `npx prisma migrate status` shows no pending migrations
- `npm run build` compiles without errors (Prisma client regenerated)
</verification>

<success_criteria>
- Alert, Integration, and WebhookDelivery models exist in schema
- All timestamps use @db.Timestamptz (UTC storage)
- Per-integration webhook secret stored in Integration.webhookSecret
- WebhookDelivery tracks idempotencyKey and contentFingerprint
- Migration applied to database
- Build succeeds with updated Prisma client
</success_criteria>

<output>
After completion, create `.planning/phases/02-alert-ingestion-webhooks/02-01-SUMMARY.md`
</output>
