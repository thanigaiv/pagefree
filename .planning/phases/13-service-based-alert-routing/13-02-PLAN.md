---
phase: 13-service-based-alert-routing
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - frontend/src/types/incident.ts
  - frontend/src/components/IncidentDetail.tsx
  - frontend/src/pages/IntegrationsPage.tsx
  - frontend/src/types/integration.ts
  - frontend/src/hooks/useIntegrations.ts
autonomous: true

must_haves:
  truths:
    - "Incident detail page shows linked service for service-routed incidents"
    - "Legacy incidents without service display correctly (no errors)"
    - "Integration edit form allows selecting default service"
    - "Default service dropdown shows only active services"
  artifacts:
    - path: "frontend/src/types/incident.ts"
      provides: "Service type in Incident interface"
      contains: "service?:"
    - path: "frontend/src/components/IncidentDetail.tsx"
      provides: "Service display in incident details"
      contains: "incident.service"
    - path: "frontend/src/pages/IntegrationsPage.tsx"
      provides: "Default service selector in integration edit"
      contains: "defaultServiceId"
  key_links:
    - from: "frontend/src/components/IncidentDetail.tsx"
      to: "/services"
      via: "Link to service page"
      pattern: "Link.*services"
    - from: "frontend/src/pages/IntegrationsPage.tsx"
      to: "useServices hook"
      via: "Fetches services for dropdown"
      pattern: "useServices"
---

<objective>
Frontend updates to display service on incident detail and allow default service configuration on integrations

Purpose: Complete the service routing user experience by showing routing context on incidents and enabling integration configuration
Output: Updated incident types and detail component, integration form with default service selector
</objective>

<execution_context>
@/Users/tvellore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tvellore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-service-based-alert-routing/13-RESEARCH.md
@.planning/phases/13-service-based-alert-routing/13-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Incident types and IncidentDetail component to show linked service</name>
  <files>frontend/src/types/incident.ts, frontend/src/components/IncidentDetail.tsx</files>
  <action>
**frontend/src/types/incident.ts:**
Add optional service field to Incident interface:
```typescript
serviceId?: string;
service?: {
  id: string;
  name: string;
  routingKey: string;
  team: { id: string; name: string };
};
```

**frontend/src/components/IncidentDetail.tsx:**
Add service display section between ExternalLinks and the info grid (around line 37-39).

Import Server icon from lucide-react.
Import Badge from '@/components/ui/badge'.
Import Link from 'react-router-dom'.

Add service section that only renders if incident.service exists:
```tsx
{incident.service && (
  <div className="mb-4">
    <span className="text-sm text-muted-foreground">Service</span>
    <div className="flex items-center gap-2 mt-1">
      <Link to={`/admin/services?selected=${incident.service.id}`}>
        <Badge variant="outline" className="hover:bg-accent cursor-pointer">
          <Server className="h-3 w-3 mr-1" />
          {incident.service.name}
        </Badge>
      </Link>
      <span className="text-xs text-muted-foreground font-mono">
        {incident.service.routingKey}
      </span>
    </div>
  </div>
)}
```

This handles ROUTE-03 display and gracefully handles legacy incidents without service (just doesn't render the section).
  </action>
  <verify>TypeScript compiles. View incident detail page for service-routed incident - service badge with link appears. View legacy incident - no service section, no errors.</verify>
  <done>Incident type includes optional service. IncidentDetail shows service info with link to services page when present. Legacy incidents handled gracefully.</done>
</task>

<task type="auto">
  <name>Task 2: Add default service selector to Integration edit form</name>
  <files>frontend/src/pages/IntegrationsPage.tsx, frontend/src/types/integration.ts, frontend/src/hooks/useIntegrations.ts</files>
  <action>
**frontend/src/types/integration.ts:**
Add defaultServiceId and defaultService to Integration interface:
```typescript
defaultServiceId?: string | null;
defaultService?: {
  id: string;
  name: string;
  team: { id: string; name: string };
} | null;
```

Add defaultServiceId to UpdateIntegrationInput:
```typescript
defaultServiceId?: string | null;
```

**frontend/src/hooks/useIntegrations.ts:**
Ensure useUpdateIntegration mutation includes defaultServiceId in the PATCH body (should already work if it passes through input).

**frontend/src/pages/IntegrationsPage.tsx:**
In the edit dialog/form (find the integration edit UI):

1. Import useServices hook from '@/hooks/useServices'
2. Fetch active services: `const { data: servicesData } = useServices({ status: 'ACTIVE' })`
3. Add defaultServiceId to form state (initialize from integration.defaultServiceId || 'none')

Add a Select component for default service after existing form fields:
```tsx
<div className="space-y-2">
  <Label htmlFor="defaultService">Default Service</Label>
  <Select
    value={formData.defaultServiceId || 'none'}
    onValueChange={(value) => setFormData({
      ...formData,
      defaultServiceId: value === 'none' ? null : value
    })}
  >
    <SelectTrigger>
      <SelectValue placeholder="No default service" />
    </SelectTrigger>
    <SelectContent>
      <SelectItem value="none">No default service</SelectItem>
      {servicesData?.services?.map((service) => (
        <SelectItem key={service.id} value={service.id}>
          {service.name} ({service.team.name})
        </SelectItem>
      ))}
    </SelectContent>
  </Select>
  <p className="text-xs text-muted-foreground">
    Alerts without explicit routing_key will route to this service
  </p>
</div>
```

Ensure form submit includes defaultServiceId in the update payload.

If IntegrationsPage uses a different form pattern (e.g., dialog with controlled inputs), adapt accordingly. Check existing form fields pattern and follow it.
  </action>
  <verify>TypeScript compiles. Open integration edit form - default service dropdown appears with active services. Select a service, save - verify PATCH includes defaultServiceId. Clear to "none", save - verify null sent.</verify>
  <done>Integration edit form has default service selector. Only active services shown. Selection persists on save. ROUTE-04 frontend complete.</done>
</task>

</tasks>

<verification>
1. Create incident via service routing (routing_key in payload)
2. View incident detail page - service badge with name and routing key visible
3. Click service badge - navigates to services page
4. View legacy incident (before Phase 13) - no service section, no errors
5. Go to Integrations page, edit an integration
6. Default service dropdown shows active services only
7. Select a service, save - verify in network tab PATCH includes defaultServiceId
8. Clear selection to "No default service", save - verify defaultServiceId: null
</verification>

<success_criteria>
- Incident detail shows service name and routing key for service-routed incidents (ROUTE-03)
- Service name is clickable link to services page
- Legacy incidents without serviceId render correctly (no errors, no service section)
- Integration edit form has default service dropdown
- Dropdown shows only ACTIVE services
- Selection saves correctly (string ID or null)
</success_criteria>

<output>
After completion, create `.planning/phases/13-service-based-alert-routing/13-02-SUMMARY.md`
</output>
