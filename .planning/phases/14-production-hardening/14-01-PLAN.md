---
phase: 14-production-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/push.service.ts
  - src/routes/push.routes.ts
  - src/services/notification/channels/push.channel.ts
  - .env.example
  - prisma/schema.prisma
autonomous: true
user_setup:
  - service: vapid
    why: "VAPID keys for web push authentication"
    env_vars:
      - name: VAPID_PUBLIC_KEY
        source: "Generated by script - copy from output"
      - name: VAPID_PRIVATE_KEY
        source: "Generated by script - copy from output"
      - name: VAPID_SUBJECT
        source: "mailto:oncall@yourdomain.com or https://yourdomain.com"

must_haves:
  truths:
    - "VAPID key pair exists in environment configuration"
    - "Push subscriptions store full PushSubscription object (endpoint + keys)"
    - "Web push notifications send with proper VAPID signature"
  artifacts:
    - path: "src/services/push.service.ts"
      provides: "VAPID key validation and web-push integration"
      contains: "webpush.setVapidDetails"
    - path: "src/scripts/generateVapidKeys.ts"
      provides: "VAPID key generation script"
      exports: ["generateVapidKeys"]
    - path: "prisma/schema.prisma"
      provides: "PushSubscription storage in UserDevice"
      contains: "pushSubscription"
  key_links:
    - from: "src/services/push.service.ts"
      to: "web-push"
      via: "webpush.sendNotification"
      pattern: "webpush\\.sendNotification"
    - from: "src/services/notification/channels/push.channel.ts"
      to: "src/services/push.service.ts"
      via: "import for web subscriptions"
      pattern: "pushService"
---

<objective>
Implement production-ready web push notifications with proper VAPID key generation, configuration, and full PushSubscription storage.

Purpose: Push notifications currently use placeholder VAPID keys. Production deployment requires actual keys with proper signature verification. Additionally, the current implementation stores only the endpoint, not the auth keys required for encrypted push.

Output: Working web push with VAPID signature verification, full subscription storage, and key generation script.
</objective>

<execution_context>
@/Users/tvellore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tvellore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing push implementation
@src/services/push.service.ts
@src/routes/push.routes.ts
@src/services/notification/channels/push.channel.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add web-push library and VAPID key generation</name>
  <files>
    package.json
    src/scripts/generateVapidKeys.ts
    .env.example
  </files>
  <action>
    1. Add web-push library: `npm install web-push`
    2. Add types: `npm install -D @types/web-push`

    3. Create VAPID key generation script at `src/scripts/generateVapidKeys.ts`:
       - Use web-push generateVAPIDKeys() to create key pair
       - Output both public and private keys to console
       - Include instructions for adding to .env
       - Script should be runnable via `npx tsx src/scripts/generateVapidKeys.ts`

    4. Update .env.example with:
       - VAPID_PUBLIC_KEY=""
       - VAPID_PRIVATE_KEY=""
       - VAPID_SUBJECT="mailto:oncall@yourdomain.com"

    Note: The web-push library provides both key generation AND notification sending with VAPID signature. This is the standard approach (not hand-rolling crypto).
  </action>
  <verify>
    Run `npx tsx src/scripts/generateVapidKeys.ts` - should output a valid VAPID key pair
    Check package.json includes web-push dependency
    Check .env.example includes VAPID_* variables
  </verify>
  <done>
    VAPID key generation script exists and produces valid key pairs. Environment configuration documented.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update push service to use web-push with VAPID</name>
  <files>
    src/services/push.service.ts
    prisma/schema.prisma
  </files>
  <action>
    1. Update prisma/schema.prisma - add pushSubscription JSON field to UserDevice:
       ```prisma
       model UserDevice {
         // existing fields...
         pushSubscription Json?  // Full PushSubscription object {endpoint, keys: {p256dh, auth}}
       }
       ```
       Run `npx prisma db push` after schema change.

    2. Refactor src/services/push.service.ts:
       - Import web-push library
       - Initialize VAPID at module load: webpush.setVapidDetails(VAPID_SUBJECT, VAPID_PUBLIC_KEY, VAPID_PRIVATE_KEY)
       - Validate VAPID keys are present (throw startup error if missing in production)
       - Update subscribe() to store full PushSubscription in new JSON field
       - Add sendNotification() method that uses webpush.sendNotification() with proper payload
       - Handle subscription expiration (410 Gone response) by removing stale subscriptions
       - Log VAPID signature verification status

    3. Ensure getVapidPublicKey() returns actual configured key (not empty string)

    Note: The web-push library handles VAPID signature generation internally. We just need to configure it and call sendNotification().
  </action>
  <verify>
    Run `npx prisma db push` successfully
    Run `npm run build` - no TypeScript errors
    Check push.service.ts imports webpush and calls setVapidDetails
  </verify>
  <done>
    Push service uses web-push library with VAPID signature. Full PushSubscription stored in database.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update push notification channel to use new service</name>
  <files>
    src/services/notification/channels/push.channel.ts
    src/routes/push.routes.ts
  </files>
  <action>
    1. Update push.channel.ts to handle web push alongside mobile (iOS/Android):
       - For platform='web' devices: use pushService.sendNotification() with full subscription from JSON field
       - For platform='ios'/'android': continue using SNS (existing behavior)
       - Build web push payload with: title, body, icon, badge, data (incidentId, priority, action)
       - Handle 410 Gone (expired subscription) by deleting device record
       - Log delivery results per platform

    2. Update src/routes/push.routes.ts:
       - Ensure subscribe endpoint stores full PushSubscription (not just endpoint)
       - Update request body validation to require keys.p256dh and keys.auth
       - Return vapidPublicKey in response for client use

    3. Add error handling for:
       - Invalid subscription (400)
       - Expired subscription (remove and log)
       - VAPID signature failure (should not happen with correct keys)
  </action>
  <verify>
    Run `npm run build` - no TypeScript errors
    Run `npm test -- src/tests/notification.test.ts` - tests pass (if applicable)
  </verify>
  <done>
    Push channel sends web notifications via web-push with VAPID signature. Mobile notifications continue via SNS.
  </done>
</task>

</tasks>

<verification>
1. VAPID key generation script runs and produces valid keys
2. Push service initializes with VAPID configuration
3. TypeScript builds without errors
4. Prisma schema updated with pushSubscription field
5. Push routes accept full subscription object
</verification>

<success_criteria>
- [ ] web-push library installed and configured
- [ ] VAPID keys can be generated via script
- [ ] UserDevice model stores full PushSubscription
- [ ] Push service sends notifications with VAPID signature
- [ ] Environment variables documented in .env.example
</success_criteria>

<output>
After completion, create `.planning/phases/14-production-hardening/14-01-SUMMARY.md`
</output>
