---
phase: 14-production-hardening
plan: 04
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/tests/webhook.test.ts
  - src/tests/integration/integration-api.test.ts
  - src/webhooks/middleware/signature-verification.ts
  - src/services/deduplication.service.ts
autonomous: true

must_haves:
  truths:
    - "All Phase 2 webhook tests pass"
    - "Datadog signature verification handles edge cases"
    - "New Relic signature verification handles edge cases"
    - "Generic HMAC signature verification works reliably"
    - "Webhooks older than 5 minutes are rejected"
  artifacts:
    - path: "src/tests/webhook.test.ts"
      provides: "Core webhook receiver tests"
      min_lines: 200
    - path: "src/webhooks/middleware/signature-verification.ts"
      provides: "Signature verification with timestamp validation"
      contains: "timestampValidation"
  key_links:
    - from: "src/tests/webhook.test.ts"
      to: "deduplication.service.ts"
      via: "team lookup for incidents"
      pattern: "deduplicationService"
---

<objective>
Fix the 10+ failing Phase 2 webhook tests and add timestamp validation to reject stale webhooks.

Purpose: Tests are failing due to environment issues (no team found for alert) and missing edge case handling. Production webhooks need timestamp validation to prevent replay attacks.

Output: All webhook tests passing with proper signature verification and timestamp validation.
</objective>

<execution_context>
@/Users/tvellore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tvellore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Test files
@src/tests/webhook.test.ts
@src/tests/integration/integration-api.test.ts
# Webhook implementation
@src/webhooks/alert-receiver.ts
@src/webhooks/middleware/signature-verification.ts
@src/services/deduplication.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix webhook test environment setup</name>
  <files>
    src/tests/webhook.test.ts
  </files>
  <action>
    The tests are failing with "No team found for alert" causing 500 errors. Fix test setup:

    1. Analyze the deduplication flow:
       - Alert created successfully (201 expected but getting 500)
       - deduplicationService.deduplicateAndCreateIncident needs a team
       - Integration may need defaultServiceId or TeamTag association

    2. Update test beforeAll to create necessary test data:
       ```typescript
       // Create a test team
       const team = await prisma.team.create({
         data: {
           name: 'test-team',
           slug: 'test-team'
         }
       });

       // Create integration with TeamTag or defaultServiceId
       integration = await prisma.integration.create({
         data: {
           name: 'test-webhook-integration',
           type: 'generic',
           webhookSecret,
           signatureHeader: 'X-Webhook-Signature',
           signatureAlgorithm: 'sha256',
           signatureFormat: 'hex',
           deduplicationWindowMinutes: 15,
           // Add team association
           teamId: team.id,  // if Integration has teamId
           // OR create TeamTag association
         }
       });

       // If using TeamTag, create one:
       await prisma.teamTag.create({
         data: {
           teamId: team.id,
           tag: integration.name  // Tag matches integration name
         }
       });
       ```

    3. Update afterAll cleanup to remove team and TeamTag in correct order

    4. Verify webhook flow finds team via:
       - Service routing (defaultServiceId -> Service -> Team)
       - TeamTag routing (source matches tag)
       - Integration routing (integration.teamId)
  </action>
  <verify>
    Run `npm test -- src/tests/webhook.test.ts` - check if 500 errors become 201
  </verify>
  <done>
    Webhook tests have proper team association in test data setup.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add timestamp validation to signature verification</name>
  <files>
    src/webhooks/middleware/signature-verification.ts
  </files>
  <action>
    Add timestamp validation to reject webhooks older than 5 minutes:

    1. For generic webhooks with timestamp header:
       - Check for X-Webhook-Timestamp or similar header
       - Parse timestamp (ISO string or Unix timestamp)
       - Reject if older than 5 minutes from now
       - Return 401 with type "webhook-expired"

    2. For Datadog webhooks:
       - Datadog includes timestamp in payload.date (Unix seconds)
       - Validate during normalization or signature check
       - 5 minute tolerance

    3. For New Relic webhooks:
       - New Relic includes timestamp in payload.timestamp (ISO string)
       - Validate during normalization

    4. Add configuration option for timestamp validation:
       ```typescript
       interface SignatureConfig {
         // existing fields...
         timestampHeader?: string;  // Header containing timestamp
         timestampMaxAge?: number;  // Max age in seconds (default 300)
       }
       ```

    5. Update Integration model if needed to store timestampHeader config

    6. Log timestamp validation failures to audit with severity WARN
  </action>
  <verify>
    Run `npm run build` - no TypeScript errors
    Create a test for expired timestamp rejection
  </verify>
  <done>
    Webhook signature verification includes timestamp validation. Webhooks older than 5 minutes rejected.
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix integration-api tests and run full test suite</name>
  <files>
    src/tests/integration/integration-api.test.ts
  </files>
  <action>
    The integration-api.test.ts has failures:
    - 401 errors on delivery endpoints (auth cookie issue)
    - undefined webhookSecret causing crypto errors

    Fix the test setup:

    1. Check adminAuthCookie generation in beforeAll:
       - Verify session is created and cookie is valid
       - The session may be expiring or not being created properly

    2. Fix webhookSecret extraction:
       - After creating integration via API, the webhookSecret may not be returned
       - Query integration directly: `await prisma.integration.findUnique({where:{id}, select:{webhookSecret:true}})`

    3. Ensure provider-specific tests (DataDog, New Relic) create appropriate integrations:
       - type: 'datadog' or type: 'newrelic'
       - With valid webhookSecret

    4. Run full test suite and document any remaining failures:
       ```bash
       npm test 2>&1 | tee test-results.txt
       ```

    5. For any remaining failures, determine if they are:
       - Test environment issues (fix setup)
       - Actual bugs (fix implementation)
       - Flaky tests (add retries or fix race conditions)
  </action>
  <verify>
    Run `npm test -- src/tests/integration/integration-api.test.ts`
    Run `npm test -- src/tests/webhook.test.ts`
    All webhook-related tests should pass
  </verify>
  <done>
    All Phase 2 webhook tests pass. Integration-api tests for webhooks pass.
  </done>
</task>

</tasks>

<verification>
RED-GREEN-REFACTOR cycle:
1. Run existing tests - document failures (RED)
2. Fix test setup and implementation (GREEN)
3. Add timestamp validation tests (RED then GREEN)
4. Full test suite passes
</verification>

<success_criteria>
- [ ] webhook.test.ts: all 11 tests pass
- [ ] integration-api.test.ts: webhook-related tests pass
- [ ] Timestamp validation rejects webhooks > 5 minutes old
- [ ] Signature verification handles encoding edge cases
- [ ] No 500 errors from missing team association
</success_criteria>

<output>
After completion, create `.planning/phases/14-production-hardening/14-04-SUMMARY.md`
</output>
