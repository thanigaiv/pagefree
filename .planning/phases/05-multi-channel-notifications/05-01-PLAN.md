---
phase: 05-multi-channel-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/services/notification/types.ts
  - src/services/notification/channels/base.channel.ts
autonomous: true

must_haves:
  truths:
    - "System can track notification delivery status per channel"
    - "System stores magic link tokens for email actions"
    - "System tracks Slack/Teams OAuth credentials per user"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "NotificationLog, MagicLinkToken, SlackConnection, TeamsConnection models"
      contains: "model NotificationLog"
    - path: "src/services/notification/types.ts"
      provides: "Channel interfaces and notification payload types"
      exports: ["NotificationChannel", "NotificationPayload", "ChannelDeliveryResult"]
    - path: "src/services/notification/channels/base.channel.ts"
      provides: "Base channel class with common retry logic"
      exports: ["BaseChannel"]
  key_links:
    - from: "NotificationLog"
      to: "Incident, User"
      via: "foreign keys"
      pattern: "incidentId.*userId"
---

<objective>
Database schema and type foundation for multi-channel notification delivery

Purpose: Establish data models for tracking notification delivery across all channels (email, SMS, push, Slack, Teams, voice) and store credentials for interactive channels. This foundation enables NOTIF-08 (delivery tracking) and supports all other requirements.

Output: Prisma models for NotificationLog, MagicLinkToken, SlackConnection, TeamsConnection; TypeScript interfaces for channel abstraction
</objective>

<execution_context>
@/Users/tvellore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tvellore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-multi-channel-notifications/05-CONTEXT.md
@.planning/phases/05-multi-channel-notifications/05-RESEARCH.md
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add notification tracking models to Prisma schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add these models to the schema (after existing models):

1. **NotificationLog** - Tracks delivery status per channel per incident:
```prisma
model NotificationLog {
  id             String   @id @default(cuid())
  incidentId     String
  incident       Incident @relation(fields: [incidentId], references: [id])
  userId         String
  user           User     @relation(fields: [userId], references: [id])
  channel        NotificationChannel

  // Delivery tracking
  status         String   // QUEUED, SENDING, SENT, DELIVERED, FAILED
  providerId     String?  // External message ID from provider
  error          String?  // Error message if failed
  attemptCount   Int      @default(0)

  // Escalation context
  escalationLevel Int?    // Which escalation level triggered this

  // Timestamps
  queuedAt       DateTime @db.Timestamptz
  sentAt         DateTime? @db.Timestamptz
  deliveredAt    DateTime? @db.Timestamptz
  lastAttemptAt  DateTime? @db.Timestamptz

  createdAt      DateTime @default(now()) @db.Timestamptz

  @@index([incidentId, channel])
  @@index([userId, status])
  @@index([incidentId, userId, channel])
}
```

2. **MagicLinkToken** - One-time tokens for email actions (per OWASP guidance):
```prisma
model MagicLinkToken {
  id          String   @id @default(cuid())
  tokenHash   String   @unique  // SHA-256 hash (never store plaintext)
  incidentId  String
  incident    Incident @relation(fields: [incidentId], references: [id])
  action      String   // 'acknowledge' or 'resolve'
  used        Boolean  @default(false)
  usedAt      DateTime? @db.Timestamptz
  expiresAt   DateTime @db.Timestamptz
  createdAt   DateTime @default(now()) @db.Timestamptz

  @@index([tokenHash])
  @@index([incidentId, action])
  @@index([expiresAt])
}
```

3. **SlackConnection** - User OAuth for Slack interactivity:
```prisma
model SlackConnection {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // OAuth tokens (encrypted in production)
  accessToken    String
  refreshToken   String?
  tokenExpiresAt DateTime? @db.Timestamptz

  // User's Slack identity
  slackUserId    String   @unique
  slackTeamId    String
  slackEmail     String?

  isActive       Boolean  @default(true)
  lastUsedAt     DateTime? @db.Timestamptz
  createdAt      DateTime @default(now()) @db.Timestamptz
  updatedAt      DateTime @updatedAt @db.Timestamptz

  @@unique([userId])
  @@index([slackUserId])
}
```

4. **TeamsConnection** - User OAuth for Teams interactivity (mirror Slack structure):
```prisma
model TeamsConnection {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // OAuth tokens (encrypted in production)
  accessToken    String
  refreshToken   String?
  tokenExpiresAt DateTime? @db.Timestamptz

  // User's Teams identity
  teamsUserId    String   @unique
  teamsTenantId  String
  teamsEmail     String?

  isActive       Boolean  @default(true)
  lastUsedAt     DateTime? @db.Timestamptz
  createdAt      DateTime @default(now()) @db.Timestamptz
  updatedAt      DateTime @updatedAt @db.Timestamptz

  @@unique([userId])
  @@index([teamsUserId])
}
```

Add relations to existing models:
- Add `notificationLogs NotificationLog[]` to User model
- Add `notificationLogs NotificationLog[]` to Incident model
- Add `magicLinkTokens MagicLinkToken[]` to Incident model
- Add `slackConnection SlackConnection?` to User model
- Add `teamsConnection TeamsConnection?` to User model

Add TEAMS to NotificationChannel enum:
```prisma
enum NotificationChannel {
  EMAIL
  SMS
  PUSH
  SLACK
  TEAMS  // Add this
  VOICE
}
```
  </action>
  <verify>npx prisma validate</verify>
  <done>Prisma schema valid with NotificationLog, MagicLinkToken, SlackConnection, TeamsConnection models</done>
</task>

<task type="auto">
  <name>Task 2: Generate migration and create type definitions</name>
  <files>src/services/notification/types.ts, src/services/notification/channels/base.channel.ts</files>
  <action>
1. Run `npx prisma db push` to apply schema changes.

2. Create `src/services/notification/types.ts`:
```typescript
// Channel delivery result from provider
export interface ChannelDeliveryResult {
  success: boolean;
  providerId?: string;  // External message ID from provider
  error?: string;
  deliveredAt?: Date;
  estimatedDelivery?: Date;  // For async channels
}

// Notification payload sent to channels
export interface NotificationPayload {
  incidentId: string;
  userId: string;
  title: string;
  body: string;
  priority: 'CRITICAL' | 'HIGH' | 'MEDIUM' | 'LOW' | 'INFO';
  service: string;
  teamName: string;
  alertCount: number;
  escalationLevel?: number;
  dashboardUrl: string;
  triggeredAt: Date;
}

// Actions available for interactive notifications
export interface NotificationAction {
  id: string;
  label: string;
  style?: 'primary' | 'danger' | 'default';
}

// Channel interface - all channels implement this
export interface NotificationChannel {
  name: string;
  send(payload: NotificationPayload): Promise<ChannelDeliveryResult>;
  supportsInteractivity(): boolean;
  getProviderStatus?(): Promise<{ healthy: boolean; latencyMs?: number }>;
}

// Delivery status enum matching database
export type DeliveryStatus = 'QUEUED' | 'SENDING' | 'SENT' | 'DELIVERED' | 'FAILED';

// Channel escalation configuration (per user decision)
export interface ChannelEscalationConfig {
  primary: string[];      // Try in parallel (push, email, slack)
  secondary: string[];    // Try if primary fails (sms)
  fallback: string[];     // Last resort (voice)
}

export const DEFAULT_CHANNEL_ESCALATION: ChannelEscalationConfig = {
  primary: ['email', 'slack', 'push'],
  secondary: ['sms'],
  fallback: ['voice']
};
```

3. Create `src/services/notification/channels/base.channel.ts`:
```typescript
import type { NotificationChannel, NotificationPayload, ChannelDeliveryResult } from '../types.js';
import { logger } from '../../../config/logger.js';

export abstract class BaseChannel implements NotificationChannel {
  abstract name: string;
  abstract send(payload: NotificationPayload): Promise<ChannelDeliveryResult>;
  abstract supportsInteractivity(): boolean;

  // Common error handling wrapper
  protected async withErrorHandling(
    operation: () => Promise<ChannelDeliveryResult>,
    context: { incidentId: string; userId: string }
  ): Promise<ChannelDeliveryResult> {
    try {
      return await operation();
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'Unknown error';
      logger.error(
        {
          channel: this.name,
          incidentId: context.incidentId,
          userId: context.userId,
          error: errorMessage
        },
        `${this.name} channel delivery failed`
      );
      return {
        success: false,
        error: errorMessage
      };
    }
  }

  // Format timestamp for display
  protected formatTimestamp(date: Date): string {
    return date.toLocaleString('en-US', {
      weekday: 'short',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      timeZoneName: 'short'
    });
  }

  // Truncate text to max length with ellipsis
  protected truncate(text: string, maxLength: number): string {
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength - 3) + '...';
  }
}
```
  </action>
  <verify>npx tsc --noEmit src/services/notification/types.ts src/services/notification/channels/base.channel.ts</verify>
  <done>Database migration applied, TypeScript interfaces compile without errors</done>
</task>

</tasks>

<verification>
- `npx prisma validate` passes
- `npx prisma db push` applies without errors
- TypeScript files compile without errors
- NotificationLog model can track per-channel delivery status
- MagicLinkToken model supports one-time email action tokens
- SlackConnection and TeamsConnection store OAuth credentials
</verification>

<success_criteria>
1. Database schema includes NotificationLog, MagicLinkToken, SlackConnection, TeamsConnection
2. NotificationChannel interface defines send() contract for all channels
3. BaseChannel provides common error handling and formatting utilities
4. TEAMS added to NotificationChannel enum
</success_criteria>

<output>
After completion, create `.planning/phases/05-multi-channel-notifications/05-01-SUMMARY.md`
</output>
