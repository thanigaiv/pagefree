---
phase: 04-alert-routing-and-deduplication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - prisma/migrations/*
autonomous: true

must_haves:
  truths:
    - "Incident model exists with status lifecycle (OPEN -> ACKNOWLEDGED -> RESOLVED)"
    - "Escalation policy can be configured per team with multiple levels"
    - "Each escalation level has configurable timeout and target"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Incident, EscalationPolicy, EscalationLevel, EscalationJob models"
      contains: "model Incident"
    - path: "prisma/migrations/*_add_incident_escalation/migration.sql"
      provides: "Database migration for new models"
  key_links:
    - from: "Incident"
      to: "Alert"
      via: "incidentId foreign key"
      pattern: "incidentId.*String"
    - from: "EscalationLevel"
      to: "EscalationPolicy"
      via: "escalationPolicyId foreign key"
      pattern: "escalationPolicyId.*@relation"
---

<objective>
Add database models for incident management and escalation policies

Purpose: Foundation for alert routing and escalation - enables incident lifecycle tracking and multi-level escalation configuration
Output: Prisma schema with Incident, EscalationPolicy, EscalationLevel, and EscalationJob models; database migration applied
</objective>

<execution_context>
@/Users/tvellore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tvellore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-alert-routing-and-deduplication/04-RESEARCH.md

# Phase 3 provides on-call service we'll reference
@.planning/phases/03-scheduling-system/03-05-SUMMARY.md

# Phase 2 Alert model we're extending
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add escalation and incident models to Prisma schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add the following models to prisma/schema.prisma after the Alert model section:

1. **EscalationPolicy model**:
   - id (cuid)
   - teamId (relation to Team)
   - name (String)
   - description (String?)
   - isDefault (Boolean, default false) - Default policy for team
   - repeatCount (Int, default 1) - Repeat policy N times before stopping (max 9)
   - isActive (Boolean, default true)
   - levels (relation to EscalationLevel[])
   - incidents (relation to Incident[])
   - createdAt, updatedAt with @db.Timestamptz
   - Indexes: [teamId], [teamId, isDefault]

2. **EscalationLevel model**:
   - id (cuid)
   - escalationPolicyId (relation to EscalationPolicy, onDelete: Cascade)
   - levelNumber (Int) - Order of escalation (1, 2, 3...)
   - targetType (String) - 'user', 'schedule', 'entire_team'
   - targetId (String?) - User ID or Schedule ID, null for entire_team
   - timeoutMinutes (Int, default 30) - Wait before escalating
   - createdAt with @db.Timestamptz
   - Unique constraint: [escalationPolicyId, levelNumber]
   - Index: [escalationPolicyId, levelNumber]

3. **Incident model**:
   - id (cuid)
   - fingerprint (String) - Deduplication key from alert
   - teamId (relation to Team)
   - escalationPolicyId (relation to EscalationPolicy)
   - currentLevel (Int, default 1) - Current escalation level
   - currentRepeat (Int, default 1) - Current repeat cycle
   - assignedUserId (String?, relation to User)
   - status (String) - 'OPEN', 'ACKNOWLEDGED', 'RESOLVED', 'CLOSED'
   - priority (String) - From first alert severity
   - alertCount (Int, default 1) - Count of grouped alerts
   - createdAt, acknowledgedAt, resolvedAt, closedAt, lastEscalatedAt with @db.Timestamptz
   - alerts (relation to Alert[])
   - escalationJobs (relation to EscalationJob[])
   - Indexes: [teamId, status], [fingerprint, status, createdAt], [assignedUserId, status], [status, createdAt]

4. **EscalationJob model** (for BullMQ job tracking):
   - id (cuid)
   - incidentId (relation to Incident)
   - bullJobId (String, @unique) - BullMQ job ID for cancellation
   - scheduledLevel (Int) - Which level this escalates to
   - scheduledFor (DateTime @db.Timestamptz)
   - completed (Boolean, default false)
   - cancelledAt (DateTime? @db.Timestamptz)
   - executedAt (DateTime? @db.Timestamptz)
   - createdAt with @db.Timestamptz
   - Index: [incidentId, completed]

5. **Update Alert model**:
   - Add incidentId (String?, relation to Incident)
   - Add index [incidentId]

6. **Update Team model**:
   - Add escalationPolicies relation (EscalationPolicy[])
   - Add incidents relation (Incident[])

7. **Update User model**:
   - Add incidentsAssigned relation (Incident[])

Use @db.Timestamptz for all DateTime fields per project convention.
  </action>
  <verify>npx prisma validate</verify>
  <done>Schema validates with all new models, relations, and indexes</done>
</task>

<task type="auto">
  <name>Task 2: Generate and apply database migration</name>
  <files>prisma/migrations/*</files>
  <action>
Run Prisma migration:
1. Generate migration: `npx prisma migrate dev --name add_incident_escalation`
2. If migration prompts for data loss, review and accept (dev database can be reset)
3. Verify Prisma client is regenerated with new types
4. Verify build succeeds: `npm run build`

Expected tables created:
- EscalationPolicy
- EscalationLevel
- Incident
- EscalationJob

Expected columns added:
- Alert.incidentId (nullable foreign key)
  </action>
  <verify>npx prisma migrate status && npm run build</verify>
  <done>Migration applied, Prisma client regenerated, TypeScript compiles</done>
</task>

</tasks>

<verification>
- [ ] `npx prisma validate` succeeds
- [ ] `npx prisma migrate status` shows "Database schema is up to date"
- [ ] `npm run build` succeeds
- [ ] New models visible in Prisma Studio: `npx prisma studio` (manual check)
</verification>

<success_criteria>
Database has Incident and EscalationPolicy models with:
- Team can have multiple escalation policies (one marked default)
- Each policy has ordered levels with timeouts
- Incidents track lifecycle status and current escalation state
- EscalationJob enables BullMQ job cancellation on acknowledgment
- Alert model can link to Incident for deduplication grouping
</success_criteria>

<output>
After completion, create `.planning/phases/04-alert-routing-and-deduplication/04-01-SUMMARY.md`
</output>
